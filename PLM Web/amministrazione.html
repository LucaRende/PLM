<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Amministrazione - PLM Web</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/PLM/favicon.ico">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Stili -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="Load/loader.css">
    
    <!-- CONTROLLO AUTENTICAZIONE -->
    <script>
        (function() {
            const isLogged = sessionStorage.getItem('plm_logged_in') || localStorage.getItem('plm_logged_in');
            if (isLogged !== 'true') {
                window.location.replace('login.html');
            }
        })();
    </script>
    
    <!-- Nascondi contenuto finch√© loader non √® attivo -->
    <style id="preload-style">
        body { background: #030305; }
        .page { visibility: hidden; }
    </style>
    
    <style>
        /* =============================================
           AMMINISTRAZIONE - OTTIMIZZATO IPHONE
           ============================================= */
        
        /* Header Fisso Premium */
        .page-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: var(--space-3) var(--space-4);
            background: rgba(3, 3, 5, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-user-info {
            display: flex;
            flex-direction: column;
        }
        
        .page-user-surname {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .page-user-name {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            line-height: 1.3;
        }
        
        .page-logo {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .page-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .btn-logout {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 10px;
            color: var(--error);
            cursor: pointer;
            transition: all var(--transition-fast);
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-logout:active {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(0.95);
        }
        
        .btn-logout svg {
            width: 18px;
            height: 18px;
        }
        
        /* Barra Titolo */
        .page-title-bar {
            position: fixed;
            top: 62px;
            left: 0;
            right: 0;
            z-index: 999;
            padding: var(--space-3) var(--space-4);
            background: rgba(3, 3, 5, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .btn-back {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-back:active {
            background: var(--surface-3);
            color: var(--primary);
            transform: scale(0.95);
        }
        
        .btn-back svg {
            width: 22px;
            height: 22px;
        }
        
        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Content */
        .page-content {
            padding: 130px var(--space-4) var(--space-4);
            min-height: 100vh;
            background: var(--surface-0);
        }
        
        /* Section Box - Panoramica Castelletti */
        .section-box {
            background: var(--surface-2);
            border: 1.5px solid var(--border-default);
            border-radius: 20px;
            margin-bottom: var(--space-4);
            overflow: hidden;
        }
        
        .section-box.expanded {
            border-color: var(--primary);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            cursor: pointer;
            transition: background var(--transition-fast);
            -webkit-tap-highlight-color: transparent;
        }
        
        .section-header:active {
            background: var(--surface-3);
        }
        
        .section-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(220, 38, 38, 0.15);
            border-radius: 14px;
            flex-shrink: 0;
        }
        
        .section-icon svg {
            width: 22px;
            height: 22px;
            color: var(--primary);
        }
        
        .section-info {
            flex: 1;
        }
        
        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .section-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .section-arrow {
            width: 24px;
            height: 24px;
            color: var(--text-muted);
            transition: transform var(--transition-fast);
        }
        
        .section-box.expanded .section-arrow {
            transform: rotate(180deg);
            color: var(--primary);
        }
        
        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .section-box.expanded .section-content {
            max-height: 10000px;
        }
        
        .section-inner {
            padding: 0 var(--space-4) var(--space-4);
        }
        
        /* =============================================
           BANCA CARD - OTTIMIZZATO MOBILE
           ============================================= */
        
        .banca-box {
            background: var(--surface-3);
            border: 1.5px solid var(--border-default);
            border-radius: 16px;
            margin-bottom: var(--space-3);
            overflow: hidden;
        }
        
        .banca-box:last-child {
            margin-bottom: 0;
        }
        
        .banca-box.expanded {
            border-color: var(--primary);
        }
        
        .banca-header {
            display: flex;
            align-items: center;
            padding: var(--space-4);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .banca-header:active {
            background: var(--surface-4);
        }
        
        .banca-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary) 0%, #b91c1c 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--space-3);
            flex-shrink: 0;
        }
        
        .banca-icon svg {
            width: 22px;
            height: 22px;
            color: white;
        }
        
        .banca-info {
            flex: 1;
            min-width: 0;
        }
        
        .banca-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        
        .banca-castelletto {
            font-size: 13px;
            color: var(--success);
            font-weight: 600;
        }
        
        .banca-arrow {
            width: 24px;
            height: 24px;
            color: var(--text-muted);
            transition: transform var(--transition-fast);
            flex-shrink: 0;
        }
        
        .banca-box.expanded .banca-arrow {
            transform: rotate(180deg);
            color: var(--primary);
        }
        
        .banca-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .banca-box.expanded .banca-content {
            max-height: 5000px;
        }
        
        .banca-inner {
            padding: 0 var(--space-4) var(--space-4);
        }
        
        /* =============================================
           STATS SUMMARY - BOX GRANDI
           ============================================= */
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }
        
        .stat-box {
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 14px;
            padding: var(--space-4);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }
        
        .stat-box-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .stat-box-value.green {
            color: var(--success);
        }
        
        .stat-box-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* =============================================
           MESI GRID - CARD PI√ô GRANDI E LEGGIBILI
           ============================================= */
        
        .mesi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-3);
        }
        
        @media (min-width: 400px) {
            .mesi-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .mese-card {
            background: var(--surface-2);
            border: 1.5px solid var(--border-default);
            border-radius: 14px;
            padding: var(--space-3);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .mese-card:active {
            transform: scale(0.95);
        }
        
        .mese-card.selected {
            border-color: var(--primary);
            background: rgba(220, 38, 38, 0.1);
        }
        
        .mese-nome {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Progress Circle - Pi√π grande */
        .mese-progress {
            width: 56px;
            height: 56px;
            margin: 0 auto var(--space-2);
        }
        
        .mese-perc {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }
        
        .mese-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .mese-badge.green {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .mese-badge.yellow {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .mese-badge.red {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        /* =============================================
           FATTURE - CARD MIGLIORATE
           ============================================= */
        
        .fatture-container {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px dashed var(--border-default);
        }
        
        .fatture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .fatture-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .fatture-count {
            background: var(--primary);
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .fatture-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-3);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .fatture-close:active {
            background: var(--surface-4);
        }
        
        .fattura-card {
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: var(--space-4);
            margin-bottom: var(--space-3);
        }
        
        .fattura-card:last-child {
            margin-bottom: 0;
        }
        
        .fattura-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }
        
        .fattura-row:last-child {
            margin-bottom: 0;
        }
        
        .fattura-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .fattura-value {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 600;
            text-align: right;
        }
        
        .fattura-value.positive {
            color: var(--success);
        }
        
        .fattura-value.negative {
            color: var(--error);
        }
        
        .fattura-cliente {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-6);
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 40px;
            margin-bottom: var(--space-3);
        }
        
        .empty-state-text {
            font-size: 14px;
        }
        
        /* =============================================
           GESTIONE ACCOUNT
           ============================================= */
        
        .btn-new-account {
            width: 100%;
            padding: var(--space-4);
            background: linear-gradient(135deg, var(--primary) 0%, #b91c1c 100%);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            cursor: pointer;
            margin-bottom: var(--space-4);
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        
        .btn-new-account:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .btn-new-account svg {
            width: 20px;
            height: 20px;
        }
        
        /* Account Card */
        .account-card {
            background: var(--surface-2);
            border: 1.5px solid var(--border-default);
            border-radius: 14px;
            margin-bottom: var(--space-3);
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .account-card:last-child {
            margin-bottom: 0;
        }
        
        .account-card.inactive {
            opacity: 0.5;
        }
        
        .account-header {
            display: flex;
            align-items: center;
            padding: var(--space-4);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .account-header:active {
            background: var(--surface-3);
        }
        
        .account-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, #b91c1c 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            margin-right: var(--space-3);
            flex-shrink: 0;
        }
        
        .account-avatar.inactive {
            background: var(--surface-4);
            color: var(--text-muted);
        }
        
        .account-info {
            flex: 1;
            min-width: 0;
        }
        
        .account-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .account-details {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }
        
        .account-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .account-badge.admin {
            background: rgba(220, 38, 38, 0.2);
            color: var(--primary);
        }
        
        .account-badge.manager {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .account-badge.utente {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .account-badge.inactive {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }
        
        .account-edit-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-3);
            border: 1px solid var(--border-default);
            border-radius: 10px;
            color: var(--text-muted);
            flex-shrink: 0;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .account-edit-btn:active {
            background: var(--surface-4);
            color: var(--primary);
        }
        
        .account-edit-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* Permessi Tags */
        .account-permessi {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 var(--space-4) var(--space-4);
        }
        
        .permesso-tag {
            padding: 4px 10px;
            background: var(--surface-3);
            border-radius: 8px;
            font-size: 10px;
            color: var(--text-secondary);
        }
        
        .permesso-tag.active {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }
        
        /* =============================================
           MODAL
           ============================================= */
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-container {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            background: var(--surface-1);
            border-radius: 24px 24px 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            border-bottom: 1px solid var(--border-default);
            flex-shrink: 0;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-3);
            border: none;
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .modal-close:active {
            background: var(--surface-4);
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-footer {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-4);
            border-top: 1px solid var(--border-default);
            flex-shrink: 0;
            padding-bottom: calc(var(--space-4) + env(safe-area-inset-bottom, 0));
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: var(--space-4);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .form-label span {
            font-weight: 400;
            text-transform: none;
            color: var(--text-muted);
            font-size: 11px;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 14px 16px;
            background: var(--surface-2);
            border: 1.5px solid var(--border-default);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: border-color 0.2s ease;
            -webkit-appearance: none;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            border-color: var(--primary);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        .form-select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        .form-textarea {
            resize: none;
            min-height: 80px;
        }
        
        /* Permessi Grid */
        .permessi-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-2);
        }
        
        .permesso-checkbox {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: 12px 14px;
            background: var(--surface-2);
            border: 1.5px solid var(--border-default);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .permesso-checkbox:has(input:checked) {
            border-color: var(--primary);
            background: rgba(220, 38, 38, 0.1);
        }
        
        .permesso-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }
        
        .permesso-label {
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .attivo-toggle {
            background: var(--surface-3);
            justify-content: center;
        }
        
        .attivo-toggle:has(input:checked) {
            background: rgba(34, 197, 94, 0.15);
            border-color: #22c55e;
        }
        
        /* Modal Buttons */
        .btn-modal {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-modal:active {
            transform: scale(0.98);
        }
        
        .btn-cancel {
            background: var(--surface-3);
            color: var(--text-secondary);
        }
        
        .btn-save {
            background: linear-gradient(135deg, var(--primary) 0%, #b91c1c 100%);
            color: white;
        }
        
        .btn-delete {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            flex: 0.5;
        }
        
        /* Footer */
        .footer {
            padding: var(--space-6) var(--space-4);
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
            border-top: 1px solid var(--border-subtle);
            margin-top: var(--space-4);
        }
        
        /* Safe area per iPhone */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .footer {
                padding-bottom: calc(var(--space-6) + env(safe-area-inset-bottom));
            }
            
            .page-header {
                padding-top: calc(var(--space-3) + env(safe-area-inset-top));
            }
            
            .page-title-bar {
                top: calc(62px + env(safe-area-inset-top));
            }
            
            .page-content {
                padding-top: calc(130px + env(safe-area-inset-top));
            }
        }
    </style>
    
    <script src="Load/loader.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            Loader.show('pagina', 'Caricamento...');
            document.querySelector('.page').style.visibility = 'visible';
        });
    </script>
</head>
<body>
    <div class="page">
        <!-- Header Fisso -->
        <header class="page-header">
            <div class="page-user-info">
                <div class="page-user-surname" id="userSurname">Cognome</div>
                <div class="page-user-name" id="userFirstName">Nome</div>
            </div>
            
            <div class="page-logo">
                <img src="/PLM/logo-tondo.png" alt="PLM">
            </div>
            
            <button class="btn-logout" onclick="logout()" title="Esci">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </button>
        </header>
        
        <!-- Barra Titolo -->
        <div class="page-title-bar">
            <button class="btn-back" onclick="window.location.href='home.html'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
            </button>
            <h1 class="page-title">Amministrazione</h1>
        </div>
        
        <!-- Content -->
        <main class="page-content">
            <!-- Sezione Panoramica Castelletti -->
            <div class="section-box" id="section-castelletti">
                <div class="section-header" onclick="toggleSection('section-castelletti')">
                    <div class="section-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="16" rx="2"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                            <line x1="9" y1="10" x2="9" y2="20"/>
                            <line x1="15" y1="10" x2="15" y2="20"/>
                        </svg>
                    </div>
                    <div class="section-info">
                        <div class="section-title">Panoramica Castelletti</div>
                        <div class="section-subtitle" id="castelletti-subtitle">Caricamento...</div>
                    </div>
                    <svg class="section-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="section-content">
                    <div class="section-inner">
                        <!-- Lista Banche -->
                        <div id="banche-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚è≥</div>
                                <div class="empty-state-text">Caricamento castelletti...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sezione Gestione Account -->
            <div class="section-box" id="section-accounts">
                <div class="section-header" onclick="toggleSection('section-accounts')">
                    <div class="section-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div class="section-info">
                        <div class="section-title">Gestione Account</div>
                        <div class="section-subtitle" id="accounts-subtitle">Caricamento...</div>
                    </div>
                    <svg class="section-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="section-content">
                    <div class="section-inner">
                        <!-- Pulsante Nuovo Account -->
                        <button class="btn-new-account" onclick="openAccountModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Nuovo Account
                        </button>
                        
                        <!-- Lista Account -->
                        <div id="accounts-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚è≥</div>
                                <div class="empty-state-text">Caricamento account...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Modal Account -->
        <div class="modal-overlay" id="account-modal">
            <div class="modal-container">
                <div class="modal-header">
                    <h2 class="modal-title" id="modal-title">Nuovo Account</h2>
                    <button class="modal-close" onclick="closeAccountModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="account-form">
                        <input type="hidden" id="account-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nome *</label>
                                <input type="text" class="form-input" id="account-nome" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cognome *</label>
                                <input type="text" class="form-input" id="account-cognome" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-input" id="account-username" required autocomplete="off">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Password <span id="password-hint">(lascia vuoto per non modificare)</span></label>
                            <input type="password" class="form-input" id="account-password" autocomplete="new-password">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="account-email">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Telefono</label>
                                <input type="tel" class="form-input" id="account-telefono">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reparto</label>
                                <input type="text" class="form-input" id="account-reparto">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ruolo</label>
                            <select class="form-select" id="account-ruolo">
                                <option value="utente">Utente</option>
                                <option value="admin">Amministratore</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Permessi Pagine</label>
                            <div class="permessi-grid">
                                <label class="permesso-checkbox">
                                    <input type="checkbox" value="home" checked disabled>
                                    <span class="permesso-label">üè† Home</span>
                                </label>
                                <label class="permesso-checkbox">
                                    <input type="checkbox" value="commerciale">
                                    <span class="permesso-label">üíº Commerciale</span>
                                </label>
                                <label class="permesso-checkbox">
                                    <input type="checkbox" value="ufficio-tecnico">
                                    <span class="permesso-label">üìê Ufficio Tecnico</span>
                                </label>
                                <label class="permesso-checkbox">
                                    <input type="checkbox" value="amministrazione">
                                    <span class="permesso-label">üìä Amministrazione</span>
                                </label>
                                <label class="permesso-checkbox">
                                    <input type="checkbox" value="bollettini">
                                    <span class="permesso-label">üìù Bollettini</span>
                                </label>
                                <label class="permesso-checkbox">
                                    <input type="checkbox" value="trasporti">
                                    <span class="permesso-label">üöö Trasporti</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Note</label>
                            <textarea class="form-textarea" id="account-note" rows="2"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="permesso-checkbox attivo-toggle">
                                <input type="checkbox" id="account-attivo" checked>
                                <span class="permesso-label">Account Attivo</span>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal btn-cancel" onclick="closeAccountModal()">Annulla</button>
                    <button class="btn-modal btn-delete" id="btn-delete" onclick="deleteAccount()" style="display: none;">Elimina</button>
                    <button class="btn-modal btn-save" onclick="saveAccount()">Salva</button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="footer">
            ¬© 2026 PLM Web ‚Äî Pro System s.r.l. ‚Äî Powered by: Luca Rende
        </footer>
    </div>

    <script>
        // =============================================
        // AMMINISTRAZIONE - PANORAMICA CASTELLETTI
        // =============================================
        
        let supabaseClient = null;
        let currentUser = null;
        
        const MESI = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
        const MESI_FULL = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                          'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        
        let allFatture = [];
        let fatturePerBanca = {};
        let castellettiPerBanca = {};
        
        // Init Supabase
        async function initSupabase() {
            try {
                const response = await fetch('/PLM/autenticazione.json');
                const config = await response.json();
                supabaseClient = supabase.createClient(config.supabase.url, config.supabase.anonKey);
                return true;
            } catch (error) {
                console.error('Errore Supabase:', error);
                return false;
            }
        }
        
        // Carica dati utente
        function loadUserData() {
            currentUser = JSON.parse(localStorage.getItem('plm_user') || sessionStorage.getItem('plm_user') || '{}');
            
            if (currentUser.cognome) {
                document.getElementById('userSurname').textContent = currentUser.cognome;
            }
            if (currentUser.nome) {
                document.getElementById('userFirstName').textContent = currentUser.nome;
            }
        }
        
        // Toggle Section
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('expanded');
        }
        
        // Toggle Banca
        function toggleBanca(bancaIdx) {
            const box = document.querySelector(`[data-banca="${bancaIdx}"]`);
            if (box) {
                // Chiudi tutte le altre
                document.querySelectorAll('.banca-box.expanded').forEach(b => {
                    if (b !== box) b.classList.remove('expanded');
                });
                box.classList.toggle('expanded');
            }
        }
        
        // Format Euro
        function formatEuro(value) {
            return new Intl.NumberFormat('it-IT', { 
                style: 'currency', 
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.abs(value));
        }
        
        // Format Euro Short
        function formatEuroShort(value) {
            const abs = Math.abs(value);
            if (abs >= 1000000) {
                return (abs / 1000000).toFixed(1) + 'M‚Ç¨';
            }
            if (abs >= 1000) {
                return (abs / 1000).toFixed(0) + 'K‚Ç¨';
            }
            return abs.toFixed(0) + '‚Ç¨';
        }
        
        // Organizza dati per banca e mese
        function organizzaDatiPerBanca(fatture) {
            fatturePerBanca = {};
            
            fatture.forEach(f => {
                const banca = f.bancaAssociata || 'Banca non specificata';
                
                if (!fatturePerBanca[banca]) {
                    fatturePerBanca[banca] = {};
                    MESI.forEach((_, idx) => {
                        fatturePerBanca[banca][idx] = [];
                    });
                }
                
                // Estrai mese dalla data scadenza
                if (f.dataScadenza) {
                    const date = new Date(f.dataScadenza);
                    const meseIdx = date.getMonth();
                    fatturePerBanca[banca][meseIdx].push(f);
                }
            });
        }
        
        // Toggle Mese (mostra fatture)
        function toggleMese(bancaIdx, meseIdx, banca) {
            const container = document.getElementById(`fatture-${bancaIdx}`);
            const currentMese = container.dataset.currentMese;
            const newMese = `${bancaIdx}-${meseIdx}`;
            
            // Deseleziona tutti i mesi
            document.querySelectorAll(`[data-banca="${bancaIdx}"] .mese-card`).forEach(c => {
                c.classList.remove('selected');
            });
            
            if (currentMese === newMese) {
                // Chiudi
                container.innerHTML = '';
                container.dataset.currentMese = '';
                return;
            }
            
            // Seleziona questo mese
            document.getElementById(`mese-${bancaIdx}-${meseIdx}`).classList.add('selected');
            container.dataset.currentMese = newMese;
            
            const fatture = fatturePerBanca[banca][meseIdx] || [];
            
            if (fatture.length === 0) {
                container.innerHTML = `
                    <div class="fatture-container">
                        <div class="fatture-header">
                            <span class="fatture-title">
                                üìÑ Fatture ${MESI_FULL[meseIdx]}
                            </span>
                            <button class="fatture-close" onclick="closeFatture(${bancaIdx})">‚úï</button>
                        </div>
                        <div class="empty-state" style="padding: var(--space-4);">
                            <div class="empty-state-icon">üì≠</div>
                            <div class="empty-state-text">Nessuna fattura in questo mese</div>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="fatture-container">
                        <div class="fatture-header">
                            <span class="fatture-title">
                                üìÑ Fatture ${MESI_FULL[meseIdx]}
                                <span class="fatture-count">${fatture.length}</span>
                            </span>
                            <button class="fatture-close" onclick="closeFatture(${bancaIdx})">‚úï</button>
                        </div>
                        ${fatture.map(f => `
                            <div class="fattura-card">
                                <div class="fattura-cliente">${f.cliente || 'Cliente non specificato'}</div>
                                <div class="fattura-row">
                                    <span class="fattura-label">N¬∞ Fattura</span>
                                    <span class="fattura-value">${f.numeroFattura || '-'}</span>
                                </div>
                                <div class="fattura-row">
                                    <span class="fattura-label">Scadenza</span>
                                    <span class="fattura-value">${f.dataScadenzaFormattato || '-'}</span>
                                </div>
                                <div class="fattura-row">
                                    <span class="fattura-label">Importo</span>
                                    <span class="fattura-value ${f.importoDaPagare < 0 ? 'positive' : 'negative'}">${f.importoDaPagare_Formattato || formatEuro(f.importoDaPagare || 0)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Scroll alle fatture
            setTimeout(() => {
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }
        
        // Chiudi fatture
        function closeFatture(bancaIdx) {
            const container = document.getElementById(`fatture-${bancaIdx}`);
            container.innerHTML = '';
            container.dataset.currentMese = '';
            document.querySelectorAll(`[data-banca="${bancaIdx}"] .mese-card`).forEach(c => {
                c.classList.remove('selected');
            });
        }
        
        // Render Banche
        function renderBanche() {
            const list = document.getElementById('banche-list');
            const banche = Object.keys(fatturePerBanca).sort();
            
            if (banche.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-text">Nessuna banca trovata</div>
                    </div>
                `;
                return;
            }
            
            document.getElementById('castelletti-subtitle').textContent = `${banche.length} banche ¬∑ ${allFatture.length} fatture`;
            
            list.innerHTML = banche.map((banca, idx) => {
                const castelletto = castellettiPerBanca[banca] || 0;
                
                // Calcola totale da pagare
                const tutteFatture = Object.values(fatturePerBanca[banca]).flat();
                const totaleDaPagare = tutteFatture.reduce((sum, f) => sum + (f.importoDaPagare || 0), 0);
                
                // Render mesi
                const mesiHtml = MESI.map((mese, meseIdx) => {
                    const fatture = fatturePerBanca[banca][meseIdx] || [];
                    const daPagareMese = fatture.reduce((sum, f) => sum + (f.importoDaPagare || 0), 0);
                    const occupato = totaleDaPagare - daPagareMese;
                    const rimanente = castelletto + occupato;
                    
                    const percentuale = castelletto > 0 
                        ? Math.min(100, Math.max(0, ((castelletto - rimanente) / castelletto) * 100))
                        : 0;
                    
                    let badgeClass = 'green';
                    let badgeText = 'OK';
                    if (percentuale > 80) {
                        badgeClass = 'red';
                        badgeText = 'Critico';
                    } else if (percentuale > 50) {
                        badgeClass = 'yellow';
                        badgeText = 'Attenz.';
                    }
                    
                    const strokeColor = percentuale > 80 ? '#ef4444' : percentuale > 50 ? '#f59e0b' : '#22c55e';
                    const circumference = Math.PI * 36; // 2 * PI * r (r=18)
                    const offset = circumference * (1 - percentuale / 100);
                    
                    return `
                        <div class="mese-card" id="mese-${idx}-${meseIdx}" onclick="toggleMese(${idx}, ${meseIdx}, '${banca.replace(/'/g, "\\'")}')">
                            <div class="mese-nome">${mese}</div>
                            <svg class="mese-progress" viewBox="0 0 50 50">
                                <circle cx="25" cy="25" r="18" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4"/>
                                <circle cx="25" cy="25" r="18" fill="none" 
                                    stroke="${strokeColor}"
                                    stroke-width="4" stroke-linecap="round"
                                    stroke-dasharray="${circumference}" 
                                    stroke-dashoffset="${offset}"
                                    transform="rotate(-90 25 25)"/>
                            </svg>
                            <div class="mese-perc">${percentuale.toFixed(0)}%</div>
                            <div class="mese-badge ${badgeClass}">${badgeText}</div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="banca-box" data-banca="${idx}">
                        <div class="banca-header" onclick="toggleBanca(${idx})">
                            <div class="banca-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z"/>
                                    <path d="M9 22V12H15V22"/>
                                </svg>
                            </div>
                            <div class="banca-info">
                                <div class="banca-name">${banca}</div>
                                <div class="banca-castelletto">üí∞ Castelletto: ${formatEuro(castelletto)}</div>
                            </div>
                            <svg class="banca-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                        <div class="banca-content">
                            <div class="banca-inner">
                                <div class="stats-summary">
                                    <div class="stat-box">
                                        <div class="stat-box-value green">${formatEuroShort(castelletto)}</div>
                                        <div class="stat-box-label">Castelletto</div>
                                    </div>
                                    <div class="stat-box">
                                        <div class="stat-box-value">${tutteFatture.length}</div>
                                        <div class="stat-box-label">Fatture Totali</div>
                                    </div>
                                </div>
                                <div class="mesi-grid">
                                    ${mesiHtml}
                                </div>
                                <div id="fatture-${idx}" data-current-mese=""></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Carica Castelletti
        async function loadCastelletti() {
            if (!supabaseClient) {
                // Demo data
                document.getElementById('castelletti-subtitle').textContent = 'Connessione non disponibile';
                return;
            }
            
            try {
                // Carica castelletti
                const { data: bancheData, error: bancheError } = await supabaseClient
                    .from('ImportiCastelletti')
                    .select('*');
                    
                if (bancheError) throw bancheError;
                
                // Mappa castelletti per nome
                if (bancheData) {
                    bancheData.forEach(b => {
                        castellettiPerBanca[b.nome] = b.totaleCastelletto || 0;
                    });
                }
                
                // Carica fatture
                const { data, error } = await supabaseClient
                    .from('FattureCastelletti')
                    .select('*');
                    
                if (error) throw error;
                
                if (data && data.length > 0) {
                    allFatture = data;
                    organizzaDatiPerBanca(data);
                    renderBanche();
                } else {
                    document.getElementById('banche-list').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-text">Nessuna fattura trovata</div>
                        </div>
                    `;
                    document.getElementById('castelletti-subtitle').textContent = 'Nessun dato';
                }
                
            } catch (error) {
                console.error('Errore caricamento castelletti:', error);
                document.getElementById('castelletti-subtitle').textContent = 'Errore caricamento';
                document.getElementById('banche-list').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Errore: ${error.message}</div>
                    </div>
                `;
            }
        }
        
        // =============================================
        // GESTIONE ACCOUNT
        // =============================================
        
        let allAccounts = [];
        const PAGINE_DISPONIBILI = [
            { id: 'home', nome: 'üè† Home', sempre: true },
            { id: 'commerciale', nome: 'üíº Commerciale' },
            { id: 'ufficio-tecnico', nome: 'üìê Ufficio Tecnico' },
            { id: 'amministrazione', nome: 'üìä Amministrazione' },
            { id: 'bollettini', nome: 'üìù Bollettini' },
            { id: 'trasporti', nome: 'üöö Trasporti' }
        ];
        
        // Carica Account
        async function loadAccounts() {
            if (!supabaseClient) {
                document.getElementById('accounts-subtitle').textContent = 'Connessione non disponibile';
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('accounts')
                    .select('*')
                    .order('cognome', { ascending: true });
                    
                if (error) throw error;
                
                allAccounts = data || [];
                document.getElementById('accounts-subtitle').textContent = `${allAccounts.length} account`;
                renderAccounts();
                
            } catch (error) {
                console.error('Errore caricamento account:', error);
                document.getElementById('accounts-subtitle').textContent = 'Errore caricamento';
                document.getElementById('accounts-list').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Errore: ${error.message}</div>
                    </div>
                `;
            }
        }
        
        // Render Account
        function renderAccounts() {
            const list = document.getElementById('accounts-list');
            
            if (allAccounts.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <div class="empty-state-text">Nessun account trovato</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = allAccounts.map(account => {
                const initials = getAccountInitials(account);
                const permessi = account.permessi_pagine || ['home'];
                const permessiArray = Array.isArray(permessi) ? permessi : JSON.parse(permessi || '["home"]');
                
                return `
                    <div class="account-card ${!account.attivo ? 'inactive' : ''}" data-id="${account.id}">
                        <div class="account-header" onclick="editAccount('${account.id}')">
                            <div class="account-avatar ${!account.attivo ? 'inactive' : ''}">${initials}</div>
                            <div class="account-info">
                                <div class="account-name">${account.cognome || ''} ${account.nome || ''}</div>
                                <div class="account-details">
                                    <span>@${account.username}</span>
                                    ${account.email ? `<span>¬∑ ${account.email}</span>` : ''}
                                </div>
                            </div>
                            <span class="account-badge ${account.ruolo || 'utente'}">${account.ruolo || 'utente'}</span>
                        </div>
                        <div class="account-permessi">
                            ${PAGINE_DISPONIBILI.map(p => `
                                <span class="permesso-tag ${permessiArray.includes(p.id) ? 'active' : ''}">${p.nome}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Get Initials
        function getAccountInitials(account) {
            const nome = account.nome || '';
            const cognome = account.cognome || '';
            return (nome.charAt(0) + cognome.charAt(0)).toUpperCase() || '??';
        }
        
        // Open Modal
        function openAccountModal(isNew = true) {
            const modal = document.getElementById('account-modal');
            const title = document.getElementById('modal-title');
            const deleteBtn = document.getElementById('btn-delete');
            const passwordHint = document.getElementById('password-hint');
            
            if (isNew) {
                title.textContent = 'Nuovo Account';
                deleteBtn.style.display = 'none';
                passwordHint.style.display = 'none';
                resetAccountForm();
            } else {
                title.textContent = 'Modifica Account';
                deleteBtn.style.display = 'block';
                passwordHint.style.display = 'inline';
            }
            
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        // Close Modal
        function closeAccountModal() {
            const modal = document.getElementById('account-modal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }
        
        // Reset Form
        function resetAccountForm() {
            document.getElementById('account-id').value = '';
            document.getElementById('account-nome').value = '';
            document.getElementById('account-cognome').value = '';
            document.getElementById('account-username').value = '';
            document.getElementById('account-password').value = '';
            document.getElementById('account-email').value = '';
            document.getElementById('account-telefono').value = '';
            document.getElementById('account-reparto').value = '';
            document.getElementById('account-ruolo').value = 'utente';
            document.getElementById('account-note').value = '';
            document.getElementById('account-attivo').checked = true;
            
            // Reset permessi (solo home checked)
            document.querySelectorAll('.permessi-grid input[type="checkbox"]').forEach(cb => {
                cb.checked = cb.value === 'home';
            });
        }
        
        // Edit Account
        function editAccount(accountId) {
            const account = allAccounts.find(a => a.id === accountId);
            if (!account) return;
            
            document.getElementById('account-id').value = account.id;
            document.getElementById('account-nome').value = account.nome || '';
            document.getElementById('account-cognome').value = account.cognome || '';
            document.getElementById('account-username').value = account.username || '';
            document.getElementById('account-password').value = '';
            document.getElementById('account-email').value = account.email || '';
            document.getElementById('account-telefono').value = account.telefono || '';
            document.getElementById('account-reparto').value = account.reparto || '';
            document.getElementById('account-ruolo').value = account.ruolo || 'utente';
            document.getElementById('account-note').value = account.note || '';
            document.getElementById('account-attivo').checked = account.attivo !== false;
            
            // Set permessi
            const permessi = account.permessi_pagine || ['home'];
            const permessiArray = Array.isArray(permessi) ? permessi : JSON.parse(permessi || '["home"]');
            
            document.querySelectorAll('.permessi-grid input[type="checkbox"]').forEach(cb => {
                if (cb.value === 'home') {
                    cb.checked = true;
                } else {
                    cb.checked = permessiArray.includes(cb.value);
                }
            });
            
            openAccountModal(false);
        }
        
        // Save Account
        async function saveAccount() {
            const accountId = document.getElementById('account-id').value;
            const nome = document.getElementById('account-nome').value.trim();
            const cognome = document.getElementById('account-cognome').value.trim();
            const username = document.getElementById('account-username').value.trim();
            const password = document.getElementById('account-password').value;
            const email = document.getElementById('account-email').value.trim();
            const telefono = document.getElementById('account-telefono').value.trim();
            const reparto = document.getElementById('account-reparto').value.trim();
            const ruolo = document.getElementById('account-ruolo').value;
            const note = document.getElementById('account-note').value.trim();
            const attivo = document.getElementById('account-attivo').checked;
            
            // Raccogli permessi
            const permessi = ['home']; // Home sempre incluso
            document.querySelectorAll('.permessi-grid input[type="checkbox"]:checked').forEach(cb => {
                if (cb.value !== 'home' && !permessi.includes(cb.value)) {
                    permessi.push(cb.value);
                }
            });
            
            // Validazione
            if (!nome || !cognome || !username) {
                alert('Nome, Cognome e Username sono obbligatori');
                return;
            }
            
            if (!accountId && !password) {
                alert('La password √® obbligatoria per i nuovi account');
                return;
            }
            
            try {
                let data, error;
                
                const accountData = {
                    nome,
                    cognome,
                    username,
                    email: email || null,
                    telefono: telefono || null,
                    reparto: reparto || null,
                    ruolo,
                    permessi_pagine: permessi,
                    note: note || null,
                    attivo
                };
                
                // Se c'√® password, aggiungila (in produzione dovresti hashare!)
                if (password) {
                    accountData.password_hash = password; // In produzione: usa bcrypt o simile
                }
                
                if (accountId) {
                    // Update
                    ({ data, error } = await supabaseClient
                        .from('accounts')
                        .update(accountData)
                        .eq('id', accountId)
                        .select());
                } else {
                    // Insert
                    if (!password) {
                        alert('Password obbligatoria per nuovi account');
                        return;
                    }
                    ({ data, error } = await supabaseClient
                        .from('accounts')
                        .insert(accountData)
                        .select());
                }
                
                if (error) throw error;
                
                closeAccountModal();
                await loadAccounts();
                
            } catch (error) {
                console.error('Errore salvataggio account:', error);
                alert('Errore: ' + error.message);
            }
        }
        
        // Delete Account
        async function deleteAccount() {
            const accountId = document.getElementById('account-id').value;
            if (!accountId) return;
            
            const account = allAccounts.find(a => a.id === accountId);
            const conferma = confirm(`Sei sicuro di voler eliminare l'account di ${account?.cognome} ${account?.nome}?`);
            
            if (!conferma) return;
            
            try {
                const { error } = await supabaseClient
                    .from('accounts')
                    .delete()
                    .eq('id', accountId);
                    
                if (error) throw error;
                
                closeAccountModal();
                await loadAccounts();
                
            } catch (error) {
                console.error('Errore eliminazione account:', error);
                alert('Errore: ' + error.message);
            }
        }
        
        // Logout
        function logout() {
            sessionStorage.removeItem('plm_logged_in');
            sessionStorage.removeItem('plm_user');
            localStorage.removeItem('plm_logged_in');
            localStorage.removeItem('plm_user');
            window.location.href = 'login.html';
        }
        
        // Init
        window.addEventListener('load', async function() {
            loadUserData();
            await initSupabase();
            await Promise.all([loadCastelletti(), loadAccounts()]);
            Loader.hide();
        });
    </script>
</body>
</html>
