<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Amministrazione - PLM Web</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/PLM/favicon.ico">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Stili -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="Load/loader.css">
    
    <!-- CONTROLLO AUTENTICAZIONE -->
    <script>
        (function() {
            const isLogged = sessionStorage.getItem('plm_logged_in') || localStorage.getItem('plm_logged_in');
            if (isLogged !== 'true') {
                window.location.replace('login.html');
            }
        })();
    </script>
    
    <!-- Nascondi contenuto finché loader non è attivo -->
    <style id="preload-style">
        body { background: #030305; }
        .page { visibility: hidden; }
    </style>
    
    <style>
        /* =============================================
           AMMINISTRAZIONE - OTTIMIZZATO IPHONE
           ============================================= */
        
        /* Header Fisso Premium */
        .page-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: var(--space-3) var(--space-4);
            background: rgba(3, 3, 5, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-user-info {
            display: flex;
            flex-direction: column;
        }
        
        .page-user-surname {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .page-user-name {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            line-height: 1.3;
        }
        
        .page-logo {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .page-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .btn-logout {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 10px;
            color: var(--error);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-logout:active {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(0.95);
        }
        
        .btn-logout svg {
            width: 18px;
            height: 18px;
        }
        
        /* Barra Titolo */
        .page-title-bar {
            position: fixed;
            top: 62px;
            left: 0;
            right: 0;
            z-index: 999;
            padding: var(--space-3) var(--space-4);
            background: rgba(3, 3, 5, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .btn-back {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-back:active {
            background: var(--surface-3);
            color: var(--primary);
            transform: scale(0.95);
        }
        
        .btn-back svg {
            width: 22px;
            height: 22px;
        }
        
        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Content */
        .page-content {
            padding: 130px var(--space-4) var(--space-4);
            min-height: 100vh;
            background: var(--surface-0);
        }
        
        /* Section Box */
        .section-box {
            background: var(--surface-2);
            border: 1.5px solid var(--border-default);
            border-radius: 20px;
            margin-bottom: var(--space-4);
            overflow: hidden;
        }
        
        .section-box.expanded {
            border-color: var(--primary);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .section-header:active {
            background: var(--surface-3);
        }
        
        .section-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(220, 38, 38, 0.15);
            border-radius: 14px;
            flex-shrink: 0;
        }
        
        .section-icon svg {
            width: 22px;
            height: 22px;
            color: var(--primary);
        }
        
        .section-info {
            flex: 1;
        }
        
        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .section-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .section-arrow {
            width: 24px;
            height: 24px;
            color: var(--text-muted);
            transition: transform 0.2s ease;
        }
        
        .section-box.expanded .section-arrow {
            transform: rotate(180deg);
            color: var(--primary);
        }
        
        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .section-box.expanded .section-content {
            max-height: 10000px;
        }
        
        .section-inner {
            padding: 0 var(--space-4) var(--space-4);
        }
        
        /* =============================================
           SELETTORE ANNO
           ============================================= */
        
        .year-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--surface-3);
            border-radius: 16px;
            margin-bottom: var(--space-4);
        }
        
        .year-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-2);
            border: 1.5px solid var(--border-default);
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .year-btn:active {
            transform: scale(0.95);
            background: var(--surface-4);
            color: var(--primary);
        }
        
        .year-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .year-display {
            min-width: 100px;
            text-align: center;
        }
        
        .year-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .year-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        /* =============================================
           GRIGLIA MESI 4x3
           ============================================= */
        
        .mesi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
        }
        
        .mese-card {
            background: var(--surface-3);
            border: 1.5px solid var(--border-default);
            border-radius: 14px;
            padding: var(--space-3);
            cursor: pointer;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }
        
        .mese-card:active {
            transform: scale(0.95);
        }
        
        .mese-card.selected {
            border-color: var(--primary);
            background: rgba(220, 38, 38, 0.1);
        }
        
        .mese-nome {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
            text-transform: uppercase;
        }
        
        .mese-progress {
            width: 50px;
            height: 50px;
            margin: 0 auto var(--space-2);
        }
        
        .mese-perc {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .mese-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .mese-badge.green { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .mese-badge.yellow { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .mese-badge.red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .mese-fatture {
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        /* =============================================
           CONTENUTO MESE ESPANSO
           ============================================= */
        
        .mese-expanded {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px dashed var(--border-default);
            display: none;
        }
        
        .mese-expanded.show { display: block; }
        
        .mese-expanded-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .mese-expanded-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .mese-expanded-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-3);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Slider Giorno */
        .day-slider-container {
            background: var(--surface-3);
            border-radius: 14px;
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }
        
        .day-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .day-slider-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .day-slider-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .day-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: var(--surface-2);
            border-radius: 4px;
            outline: none;
        }
        
        .day-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, #b91c1c 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
        }
        
        .day-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, #b91c1c 100%);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .day-slider-info {
            display: flex;
            justify-content: space-between;
            margin-top: var(--space-2);
            font-size: 10px;
            color: var(--text-muted);
        }
        
        /* Stats Riepilogo */
        .stats-riepilogo {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }
        
        .stat-mini {
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: var(--space-3);
            text-align: center;
        }
        
        .stat-mini-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .stat-mini-value.green { color: #22c55e; }
        .stat-mini-value.red { color: #ef4444; }
        
        .stat-mini-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        /* Banca Card */
        .banca-card {
            background: var(--surface-2);
            border: 1.5px solid var(--border-default);
            border-radius: 14px;
            margin-bottom: var(--space-3);
            overflow: hidden;
        }
        
        .banca-card:last-child { margin-bottom: 0; }
        .banca-card.expanded { border-color: var(--primary); }
        
        .banca-card-header {
            display: flex;
            align-items: center;
            padding: var(--space-3);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .banca-card-header:active { background: var(--surface-3); }
        
        .banca-card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, #b91c1c 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--space-3);
            flex-shrink: 0;
        }
        
        .banca-card-icon svg {
            width: 20px;
            height: 20px;
            color: white;
        }
        
        .banca-card-info { flex: 1; min-width: 0; }
        
        .banca-card-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .banca-card-stats {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            gap: var(--space-2);
        }
        
        .banca-card-stats .green { color: #22c55e; }
        .banca-card-stats .red { color: #ef4444; }
        
        .banca-card-arrow {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }
        
        .banca-card.expanded .banca-card-arrow {
            transform: rotate(180deg);
            color: var(--primary);
        }
        
        .banca-card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .banca-card.expanded .banca-card-content { max-height: 2000px; }
        
        .banca-card-inner { padding: 0 var(--space-3) var(--space-3); }
        
        /* Fattura Item */
        .fattura-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--surface-3);
            border-radius: 10px;
            margin-bottom: var(--space-2);
        }
        
        .fattura-item:last-child { margin-bottom: 0; }
        .fattura-item.filtered-out { opacity: 0.3; }
        
        .fattura-giorno {
            width: 36px;
            height: 36px;
            background: var(--surface-4);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            flex-shrink: 0;
        }
        
        .fattura-giorno.past { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .fattura-giorno.today { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .fattura-giorno.future { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        
        .fattura-info { flex: 1; min-width: 0; }
        
        .fattura-cliente {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .fattura-numero {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .fattura-importo {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            flex-shrink: 0;
        }
        
        .no-fatture {
            text-align: center;
            padding: var(--space-4);
            color: var(--text-muted);
            font-size: 13px;
        }
        
        /* =============================================
           GESTIONE ACCOUNT
           ============================================= */
        
        .btn-new-account {
            width: 100%;
            padding: var(--space-4);
            background: linear-gradient(135deg, var(--primary) 0%, #b91c1c 100%);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            cursor: pointer;
            margin-bottom: var(--space-4);
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-new-account:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .btn-new-account svg {
            width: 20px;
            height: 20px;
        }
        
        .account-card {
            background: var(--surface-3);
            border: 1.5px solid var(--border-default);
            border-radius: 14px;
            margin-bottom: var(--space-3);
            overflow: hidden;
        }
        
        .account-card:last-child { margin-bottom: 0; }
        .account-card.inactive { opacity: 0.5; }
        
        .account-header {
            display: flex;
            align-items: center;
            padding: var(--space-4);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .account-header:active { background: var(--surface-4); }
        
        .account-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, #b91c1c 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            margin-right: var(--space-3);
            flex-shrink: 0;
        }
        
        .account-avatar.inactive {
            background: var(--surface-4);
            color: var(--text-muted);
        }
        
        .account-info { flex: 1; min-width: 0; }
        
        .account-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .account-details {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .account-badge {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .account-badge.admin { background: rgba(220, 38, 38, 0.2); color: var(--primary); }
        .account-badge.manager { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .account-badge.utente { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        
        /* =============================================
           MODAL
           ============================================= */
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }
        
        .modal-overlay.show { display: flex; }
        
        .modal-container {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            background: var(--surface-1);
            border-radius: 24px 24px 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            border-bottom: 1px solid var(--border-default);
            flex-shrink: 0;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-3);
            border: none;
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-footer {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-4);
            border-top: 1px solid var(--border-default);
            flex-shrink: 0;
            padding-bottom: calc(var(--space-4) + env(safe-area-inset-bottom, 0));
        }
        
        .form-group { margin-bottom: var(--space-4); }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
            text-transform: uppercase;
        }
        
        .form-label span {
            font-weight: 400;
            text-transform: none;
            color: var(--text-muted);
            font-size: 11px;
        }
        
        .form-input,
        .form-select {
            width: 100%;
            padding: 14px 16px;
            background: var(--surface-2);
            border: 1.5px solid var(--border-default);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
            -webkit-appearance: none;
        }
        
        .form-input:focus,
        .form-select:focus {
            border-color: var(--primary);
        }
        
        .form-select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        .attivo-toggle {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: 14px 16px;
            background: var(--surface-3);
            border: 1.5px solid var(--border-default);
            border-radius: 12px;
            cursor: pointer;
            justify-content: center;
        }
        
        .attivo-toggle:has(input:checked) {
            background: rgba(34, 197, 94, 0.15);
            border-color: #22c55e;
        }
        
        .attivo-toggle input {
            width: 18px;
            height: 18px;
            accent-color: #22c55e;
        }
        
        .attivo-toggle span {
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .btn-modal {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-modal:active { transform: scale(0.98); }
        .btn-cancel { background: var(--surface-3); color: var(--text-secondary); }
        .btn-save { background: linear-gradient(135deg, var(--primary) 0%, #b91c1c 100%); color: white; }
        .btn-delete { background: rgba(239, 68, 68, 0.15); color: #ef4444; flex: 0.5; }
        
        .empty-state {
            text-align: center;
            padding: var(--space-6);
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 40px;
            margin-bottom: var(--space-3);
        }
        
        .empty-state-text { font-size: 14px; }
        
        .footer {
            padding: var(--space-6) var(--space-4);
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
            border-top: 1px solid var(--border-subtle);
            margin-top: var(--space-4);
        }
        
        /* Safe area iPhone */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .footer { padding-bottom: calc(var(--space-6) + env(safe-area-inset-bottom)); }
            .page-header { padding-top: calc(var(--space-3) + env(safe-area-inset-top)); }
            .page-title-bar { top: calc(62px + env(safe-area-inset-top)); }
            .page-content { padding-top: calc(130px + env(safe-area-inset-top)); }
        }
    </style>
    
    <script src="Load/loader.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            Loader.show('pagina', 'Caricamento...');
            document.querySelector('.page').style.visibility = 'visible';
        });
    </script>
</head>
<body>
    <div class="page">
        <!-- Header Fisso -->
        <header class="page-header">
            <div class="page-user-info">
                <div class="page-user-surname" id="userSurname">Cognome</div>
                <div class="page-user-name" id="userFirstName">Nome</div>
            </div>
            <div class="page-logo">
                <img src="/PLM/logo-tondo.png" alt="PLM">
            </div>
            <button class="btn-logout" onclick="logout()" title="Esci">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </button>
        </header>
        
        <!-- Barra Titolo -->
        <div class="page-title-bar">
            <button class="btn-back" onclick="window.location.href='home.html'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
            </button>
            <h1 class="page-title">Amministrazione</h1>
        </div>
        
        <!-- Content -->
        <main class="page-content">
            <!-- Sezione Panoramica Castelletti -->
            <div class="section-box expanded" id="section-castelletti">
                <div class="section-header" onclick="toggleSection('section-castelletti')">
                    <div class="section-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="16" rx="2"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                            <line x1="9" y1="10" x2="9" y2="20"/>
                            <line x1="15" y1="10" x2="15" y2="20"/>
                        </svg>
                    </div>
                    <div class="section-info">
                        <div class="section-title">Panoramica Castelletti</div>
                        <div class="section-subtitle" id="castelletti-subtitle">Caricamento...</div>
                    </div>
                    <svg class="section-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="section-content">
                    <div class="section-inner">
                        <!-- Selettore Anno -->
                        <div class="year-selector">
                            <button class="year-btn" onclick="changeYear(-1)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 18 9 12 15 6"/>
                                </svg>
                            </button>
                            <div class="year-display">
                                <div class="year-value" id="current-year">2026</div>
                                <div class="year-label">Anno</div>
                            </div>
                            <button class="year-btn" onclick="changeYear(1)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Griglia Mesi 4x3 -->
                        <div class="mesi-grid" id="mesi-grid"></div>
                        
                        <!-- Contenuto Mese Espanso -->
                        <div class="mese-expanded" id="mese-expanded">
                            <div class="mese-expanded-header">
                                <span class="mese-expanded-title" id="mese-expanded-title">Gennaio 2026</span>
                                <button class="mese-expanded-close" onclick="closeMeseExpanded()">✕</button>
                            </div>
                            
                            <!-- Slider Giorno -->
                            <div class="day-slider-container">
                                <div class="day-slider-header">
                                    <span class="day-slider-label">Situazione al giorno</span>
                                    <span class="day-slider-value" id="day-slider-value">31</span>
                                </div>
                                <input type="range" class="day-slider" id="day-slider" min="1" max="31" value="31" oninput="updateDayFilter(this.value)">
                                <div class="day-slider-info">
                                    <span>1</span>
                                    <span id="day-slider-max">31</span>
                                </div>
                            </div>
                            
                            <!-- Stats Riepilogo -->
                            <div class="stats-riepilogo">
                                <div class="stat-mini">
                                    <div class="stat-mini-value" id="stat-totale-fatture">0</div>
                                    <div class="stat-mini-label">Fatture</div>
                                </div>
                                <div class="stat-mini">
                                    <div class="stat-mini-value red" id="stat-totale-importo">€0</div>
                                    <div class="stat-mini-label">Tot. Scadenze</div>
                                </div>
                            </div>
                            
                            <!-- Lista Banche -->
                            <div id="banche-list"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sezione Gestione Account -->
            <div class="section-box" id="section-accounts">
                <div class="section-header" onclick="toggleSection('section-accounts')">
                    <div class="section-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div class="section-info">
                        <div class="section-title">Gestione Account</div>
                        <div class="section-subtitle" id="accounts-subtitle">Caricamento...</div>
                    </div>
                    <svg class="section-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="section-content">
                    <div class="section-inner">
                        <button class="btn-new-account" onclick="openAccountModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Nuovo Account
                        </button>
                        <div id="accounts-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">⏳</div>
                                <div class="empty-state-text">Caricamento account...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Modal Account -->
        <div class="modal-overlay" id="account-modal">
            <div class="modal-container">
                <div class="modal-header">
                    <h2 class="modal-title" id="modal-title">Nuovo Account</h2>
                    <button class="modal-close" onclick="closeAccountModal()">✕</button>
                </div>
                <div class="modal-body">
                    <form id="account-form">
                        <input type="hidden" id="account-id">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nome *</label>
                                <input type="text" class="form-input" id="account-nome" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cognome *</label>
                                <input type="text" class="form-input" id="account-cognome" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-input" id="account-username" required autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password <span id="password-hint">(lascia vuoto per non modificare)</span></label>
                            <input type="password" class="form-input" id="account-password" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="account-email">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ruolo</label>
                            <select class="form-select" id="account-ruolo">
                                <option value="utente">Utente</option>
                                <option value="admin">Amministratore</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="attivo-toggle">
                                <input type="checkbox" id="account-attivo" checked>
                                <span>Account Attivo</span>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal btn-cancel" onclick="closeAccountModal()">Annulla</button>
                    <button class="btn-modal btn-delete" id="btn-delete" onclick="deleteAccount()" style="display: none;">Elimina</button>
                    <button class="btn-modal btn-save" onclick="saveAccount()">Salva</button>
                </div>
            </div>
        </div>
        
        <footer class="footer">
            © 2026 PLM Web — Pro System s.r.l. — Powered by: Luca Rende
        </footer>
    </div>

    <script>
        let supabaseClient = null;
        let currentUser = null;
        
        const MESI = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
        const MESI_FULL = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                          'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        
        let allFatture = [];
        let castellettiPerBanca = {};
        let currentYear = new Date().getFullYear();
        let selectedMese = null;
        let currentDayFilter = 31;
        
        async function initSupabase() {
            try {
                const response = await fetch('/PLM/autenticazione.json');
                const config = await response.json();
                supabaseClient = supabase.createClient(config.supabase.url, config.supabase.anonKey);
                return true;
            } catch (error) {
                console.error('Errore Supabase:', error);
                return false;
            }
        }
        
        function loadUserData() {
            currentUser = JSON.parse(localStorage.getItem('plm_user') || sessionStorage.getItem('plm_user') || '{}');
            if (currentUser.cognome) document.getElementById('userSurname').textContent = currentUser.cognome;
            if (currentUser.nome) document.getElementById('userFirstName').textContent = currentUser.nome;
        }
        
        function toggleSection(sectionId) {
            document.getElementById(sectionId).classList.toggle('expanded');
        }
        
        function formatEuro(value) {
            return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(Math.abs(value));
        }
        
        function formatEuroShort(value) {
            const abs = Math.abs(value);
            if (abs >= 1000000) return (abs / 1000000).toFixed(1) + 'M€';
            if (abs >= 1000) return (abs / 1000).toFixed(0) + 'K€';
            return abs.toFixed(0) + '€';
        }
        
        function changeYear(delta) {
            currentYear += delta;
            document.getElementById('current-year').textContent = currentYear;
            closeMeseExpanded();
            renderMesiGrid();
        }
        
        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }
        
        function getFatturePerMese(meseIdx) {
            return allFatture.filter(f => {
                if (!f.dataScadenza) return false;
                const date = new Date(f.dataScadenza);
                return date.getMonth() === meseIdx && date.getFullYear() === currentYear;
            });
        }
        
        function calcMeseStats(meseIdx) {
            const fattureMese = getFatturePerMese(meseIdx);
            const totale = fattureMese.reduce((sum, f) => sum + (f.importoDaPagare || 0), 0);
            const totCastelletto = Object.values(castellettiPerBanca).reduce((sum, c) => sum + c, 0);
            const percentuale = totCastelletto > 0 ? Math.min(100, (totale / totCastelletto) * 100) : 0;
            
            let badgeClass = 'green', badgeText = 'OK';
            if (percentuale > 80) { badgeClass = 'red'; badgeText = 'Critico'; }
            else if (percentuale > 50) { badgeClass = 'yellow'; badgeText = 'Attenz.'; }
            
            return { fatture: fattureMese.length, totale, percentuale, badgeClass, badgeText };
        }
        
        function renderMesiGrid() {
            const grid = document.getElementById('mesi-grid');
            grid.innerHTML = MESI.map((mese, idx) => {
                const stats = calcMeseStats(idx);
                const strokeColor = stats.percentuale > 80 ? '#ef4444' : stats.percentuale > 50 ? '#f59e0b' : '#22c55e';
                const circumference = Math.PI * 36;
                const offset = circumference * (1 - stats.percentuale / 100);
                
                // Calcola fatture filtrate per giorno (se è il mese selezionato)
                let fattureLabel = `${stats.fatture} fatt.`;
                if (selectedMese === idx) {
                    const fattureMese = getFatturePerMese(idx);
                    const numFiltered = fattureMese.filter(f => f.dataScadenza && new Date(f.dataScadenza).getDate() <= currentDayFilter).length;
                    fattureLabel = `${numFiltered} su ${stats.fatture}`;
                }
                
                return `
                    <div class="mese-card ${selectedMese === idx ? 'selected' : ''}" onclick="selectMese(${idx})">
                        <div class="mese-nome">${mese}</div>
                        <svg class="mese-progress" viewBox="0 0 50 50">
                            <circle cx="25" cy="25" r="18" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4"/>
                            <circle cx="25" cy="25" r="18" fill="none" stroke="${strokeColor}" stroke-width="4" stroke-linecap="round"
                                stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" transform="rotate(-90 25 25)"/>
                        </svg>
                        <div class="mese-fatture" id="mese-fatture-${idx}">${fattureLabel}</div>
                        <div class="mese-badge ${stats.badgeClass}">${stats.badgeText}</div>
                    </div>
                `;
            }).join('');
        }
        
        function selectMese(meseIdx) {
            if (selectedMese === meseIdx) { closeMeseExpanded(); return; }
            
            selectedMese = meseIdx;
            const daysInMonth = getDaysInMonth(meseIdx, currentYear);
            currentDayFilter = daysInMonth;
            
            document.getElementById('mese-expanded-title').textContent = `${MESI_FULL[meseIdx]} ${currentYear}`;
            document.getElementById('day-slider').max = daysInMonth;
            document.getElementById('day-slider').value = daysInMonth;
            document.getElementById('day-slider-value').textContent = daysInMonth;
            document.getElementById('day-slider-max').textContent = daysInMonth;
            
            renderBanchePerMese();
            document.getElementById('mese-expanded').classList.add('show');
            renderMesiGrid();
            
            setTimeout(() => {
                document.getElementById('mese-expanded').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        function closeMeseExpanded() {
            selectedMese = null;
            document.getElementById('mese-expanded').classList.remove('show');
            renderMesiGrid();
        }
        
        function updateDayFilter(day) {
            currentDayFilter = parseInt(day);
            document.getElementById('day-slider-value').textContent = day;
            applyDayFilter();
            updateStatsRiepilogo();
            
            // Aggiorna anche il numero fatture nella card del mese selezionato
            if (selectedMese !== null) {
                const fattureMese = getFatturePerMese(selectedMese);
                const totale = fattureMese.length;
                const numFiltered = fattureMese.filter(f => f.dataScadenza && new Date(f.dataScadenza).getDate() <= currentDayFilter).length;
                const meseCard = document.getElementById(`mese-fatture-${selectedMese}`);
                if (meseCard) meseCard.textContent = `${numFiltered} su ${totale}`;
            }
        }
        
        function applyDayFilter() {
            document.querySelectorAll('.fattura-item').forEach(item => {
                const day = parseInt(item.dataset.day);
                item.classList.toggle('filtered-out', day > currentDayFilter);
            });
        }
        
        function updateStatsRiepilogo() {
            if (selectedMese === null) return;
            const fattureMese = getFatturePerMese(selectedMese);
            const totale = fattureMese.length;
            const fattureFiltered = fattureMese.filter(f => f.dataScadenza && new Date(f.dataScadenza).getDate() <= currentDayFilter);
            const importoFiltered = fattureFiltered.reduce((sum, f) => sum + (f.importoDaPagare || 0), 0);
            
            document.getElementById('stat-totale-fatture').textContent = `${fattureFiltered.length} su ${totale}`;
            document.getElementById('stat-totale-importo').textContent = formatEuro(importoFiltered);
        }
        
        function renderBanchePerMese() {
            if (selectedMese === null) return;
            
            const fattureMese = getFatturePerMese(selectedMese);
            const bancheMap = {};
            fattureMese.forEach(f => {
                const banca = f.bancaAssociata || 'Banca non specificata';
                if (!bancheMap[banca]) bancheMap[banca] = [];
                bancheMap[banca].push(f);
            });
            
            const banche = Object.keys(bancheMap).sort();
            const totale = fattureMese.length;
            const fattureFiltered = fattureMese.filter(f => f.dataScadenza && new Date(f.dataScadenza).getDate() <= currentDayFilter);
            const importoFiltered = fattureFiltered.reduce((sum, f) => sum + (f.importoDaPagare || 0), 0);
            
            document.getElementById('stat-totale-fatture').textContent = `${fattureFiltered.length} su ${totale}`;
            document.getElementById('stat-totale-importo').textContent = formatEuro(importoFiltered);
            
            if (banche.length === 0) {
                document.getElementById('banche-list').innerHTML = '<div class="no-fatture">📭 Nessuna fattura in questo mese</div>';
                return;
            }
            
            document.getElementById('banche-list').innerHTML = banche.map((banca, idx) => {
                const fatture = bancheMap[banca];
                const totBanca = fatture.reduce((sum, f) => sum + (f.importoDaPagare || 0), 0);
                const castelletto = castellettiPerBanca[banca] || 0;
                
                fatture.sort((a, b) => {
                    const dayA = a.dataScadenza ? new Date(a.dataScadenza).getDate() : 0;
                    const dayB = b.dataScadenza ? new Date(b.dataScadenza).getDate() : 0;
                    return dayA - dayB;
                });
                
                const today = new Date();
                const fattureHtml = fatture.map(f => {
                    const date = f.dataScadenza ? new Date(f.dataScadenza) : null;
                    const day = date ? date.getDate() : '?';
                    let dayClass = 'future';
                    if (date) {
                        if (date < today) dayClass = 'past';
                        else if (date.toDateString() === today.toDateString()) dayClass = 'today';
                    }
                    
                    return `
                        <div class="fattura-item ${day > currentDayFilter ? 'filtered-out' : ''}" data-day="${day}">
                            <div class="fattura-giorno ${dayClass}">${day}</div>
                            <div class="fattura-info">
                                <div class="fattura-cliente">${f.cliente || 'N/D'}</div>
                                <div class="fattura-numero">Fatt. ${String(f.numeroFattura || '-')}</div>
                            </div>
                            <div class="fattura-importo">${formatEuro(f.importoDaPagare || 0)}</div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="banca-card" id="banca-${idx}">
                        <div class="banca-card-header" onclick="toggleBancaCard(${idx})">
                            <div class="banca-card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z"/>
                                    <path d="M9 22V12H15V22"/>
                                </svg>
                            </div>
                            <div class="banca-card-info">
                                <div class="banca-card-name">${banca}</div>
                                <div class="banca-card-stats">
                                    <span>${fatture.length} fatture</span>
                                    <span>·</span>
                                    <span class="red">${formatEuroShort(totBanca)}</span>
                                    ${castelletto > 0 ? `<span>·</span><span class="green">Cast. ${formatEuroShort(castelletto)}</span>` : ''}
                                </div>
                            </div>
                            <svg class="banca-card-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                        <div class="banca-card-content">
                            <div class="banca-card-inner">${fattureHtml}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleBancaCard(idx) {
            const card = document.getElementById(`banca-${idx}`);
            if (card) {
                document.querySelectorAll('.banca-card.expanded').forEach(c => { if (c !== card) c.classList.remove('expanded'); });
                card.classList.toggle('expanded');
            }
        }
        
        async function loadCastelletti() {
            if (!supabaseClient) { document.getElementById('castelletti-subtitle').textContent = 'Connessione non disponibile'; return; }
            
            try {
                const { data: bancheData, error: bancheError } = await supabaseClient.from('ImportiCastelletti').select('*');
                if (bancheError) throw bancheError;
                if (bancheData) bancheData.forEach(b => { castellettiPerBanca[b.nome] = b.totaleCastelletto || 0; });
                
                const { data, error } = await supabaseClient.from('FattureCastelletti').select('*');
                if (error) throw error;
                
                allFatture = data || [];
                const numBanche = Object.keys(castellettiPerBanca).length;
                document.getElementById('castelletti-subtitle').textContent = `${numBanche} banche · ${allFatture.length} fatture`;
                document.getElementById('current-year').textContent = currentYear;
                renderMesiGrid();
            } catch (error) {
                console.error('Errore caricamento castelletti:', error);
                document.getElementById('castelletti-subtitle').textContent = 'Errore caricamento';
            }
        }
        
        // =============================================
        // GESTIONE ACCOUNT
        // =============================================
        
        let allAccounts = [];
        
        async function loadAccounts() {
            if (!supabaseClient) { document.getElementById('accounts-subtitle').textContent = 'Connessione non disponibile'; return; }
            
            try {
                const { data, error } = await supabaseClient.from('accounts').select('*').order('cognome', { ascending: true });
                if (error) throw error;
                
                allAccounts = data || [];
                document.getElementById('accounts-subtitle').textContent = `${allAccounts.length} account`;
                renderAccounts();
            } catch (error) {
                console.error('Errore caricamento account:', error);
                document.getElementById('accounts-subtitle').textContent = 'Errore caricamento';
                document.getElementById('accounts-list').innerHTML = `<div class="empty-state"><div class="empty-state-icon">⚠️</div><div class="empty-state-text">Errore: ${error.message}</div></div>`;
            }
        }
        
        function renderAccounts() {
            const list = document.getElementById('accounts-list');
            if (allAccounts.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">👤</div><div class="empty-state-text">Nessun account trovato</div></div>';
                return;
            }
            
            list.innerHTML = allAccounts.map(account => {
                const initials = ((account.nome || '').charAt(0) + (account.cognome || '').charAt(0)).toUpperCase() || '??';
                return `
                    <div class="account-card ${!account.attivo ? 'inactive' : ''}" data-id="${account.id}">
                        <div class="account-header" onclick="editAccount('${account.id}')">
                            <div class="account-avatar ${!account.attivo ? 'inactive' : ''}">${initials}</div>
                            <div class="account-info">
                                <div class="account-name">${account.cognome || ''} ${account.nome || ''}</div>
                                <div class="account-details">@${account.username}${account.email ? ` · ${account.email}` : ''}</div>
                            </div>
                            <span class="account-badge ${account.ruolo || 'utente'}">${account.ruolo || 'utente'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openAccountModal(isNew = true) {
            const modal = document.getElementById('account-modal');
            document.getElementById('modal-title').textContent = isNew ? 'Nuovo Account' : 'Modifica Account';
            document.getElementById('btn-delete').style.display = isNew ? 'none' : 'block';
            document.getElementById('password-hint').style.display = isNew ? 'none' : 'inline';
            if (isNew) resetAccountForm();
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        function closeAccountModal() {
            document.getElementById('account-modal').classList.remove('show');
            document.body.style.overflow = '';
        }
        
        function resetAccountForm() {
            ['account-id', 'account-nome', 'account-cognome', 'account-username', 'account-password', 'account-email'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('account-ruolo').value = 'utente';
            document.getElementById('account-attivo').checked = true;
        }
        
        function editAccount(accountId) {
            const account = allAccounts.find(a => a.id === accountId);
            if (!account) return;
            
            document.getElementById('account-id').value = account.id;
            document.getElementById('account-nome').value = account.nome || '';
            document.getElementById('account-cognome').value = account.cognome || '';
            document.getElementById('account-username').value = account.username || '';
            document.getElementById('account-password').value = '';
            document.getElementById('account-email').value = account.email || '';
            document.getElementById('account-ruolo').value = account.ruolo || 'utente';
            document.getElementById('account-attivo').checked = account.attivo !== false;
            
            openAccountModal(false);
        }
        
        async function saveAccount() {
            const accountId = document.getElementById('account-id').value;
            const nome = document.getElementById('account-nome').value.trim();
            const cognome = document.getElementById('account-cognome').value.trim();
            const username = document.getElementById('account-username').value.trim();
            const password = document.getElementById('account-password').value;
            const email = document.getElementById('account-email').value.trim();
            const ruolo = document.getElementById('account-ruolo').value;
            const attivo = document.getElementById('account-attivo').checked;
            
            if (!nome || !cognome || !username) { alert('Nome, Cognome e Username sono obbligatori'); return; }
            if (!accountId && !password) { alert('La password è obbligatoria per i nuovi account'); return; }
            
            try {
                const accountData = { nome, cognome, username, email: email || null, ruolo, attivo };
                if (password) accountData.password_hash = password;
                
                let result;
                if (accountId) {
                    result = await supabaseClient.from('accounts').update(accountData).eq('id', accountId).select();
                } else {
                    result = await supabaseClient.from('accounts').insert(accountData).select();
                }
                
                if (result.error) throw result.error;
                closeAccountModal();
                await loadAccounts();
            } catch (error) {
                console.error('Errore salvataggio account:', error);
                alert('Errore: ' + error.message);
            }
        }
        
        async function deleteAccount() {
            const accountId = document.getElementById('account-id').value;
            if (!accountId) return;
            
            const account = allAccounts.find(a => a.id === accountId);
            if (!confirm(`Sei sicuro di voler eliminare l'account di ${account?.cognome} ${account?.nome}?`)) return;
            
            try {
                const { error } = await supabaseClient.from('accounts').delete().eq('id', accountId);
                if (error) throw error;
                closeAccountModal();
                await loadAccounts();
            } catch (error) {
                console.error('Errore eliminazione account:', error);
                alert('Errore: ' + error.message);
            }
        }
        
        function logout() {
            sessionStorage.removeItem('plm_logged_in');
            sessionStorage.removeItem('plm_user');
            localStorage.removeItem('plm_logged_in');
            localStorage.removeItem('plm_user');
            window.location.href = 'login.html';
        }
        
        window.addEventListener('load', async function() {
            loadUserData();
            await initSupabase();
            await Promise.all([loadCastelletti(), loadAccounts()]);
            Loader.hide();
        });
    </script>
</body>
</html>
