<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bollettini Montatori - PLM Web</title>
    
    <link rel="icon" type="image/x-icon" href="/PLM/favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="Load/loader.css">
    <link rel="stylesheet" href="bollettini.css">
    
    <script src="Load/loader.js"></script>
    
    <script>
        (function() {
            const isLogged = sessionStorage.getItem('plm_logged_in') || localStorage.getItem('plm_logged_in');
            if (isLogged !== 'true') {
                window.location.replace('login.html');
            }
        })();
    </script>
    
    <style id="preload-style">
        body { background: #030305; }
    </style>
</head>
<body>
    <div class="page">
        <header class="page-header">
            <div class="page-user-info">
                <div class="page-user-surname" id="userSurname">Caricamento...</div>
                <div class="page-user-name" id="userFirstName"></div>
            </div>
            <div class="page-logo">
                <img src="/PLM/logo-tondo.png" alt="Logo">
            </div>
            <button class="btn-logout" onclick="logout()" title="Esci">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </button>
        </header>
        
        <div class="page-title-bar">
            <button class="btn-back" onclick="window.location.href='home.html'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
            </button>
            <h1 class="page-title">Bollettini</h1>
        </div>
        
        <section class="search-filters-section">
            <div class="search-row">
                <div class="search-bar">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="text" id="search-input" placeholder="Cerca cliente, macchina..." oninput="handleSearchInput()">
                    <button class="btn-clear-search" id="btn-clear-search" onclick="clearSearch()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <button class="btn-expand-filters" id="btn-expand-filters" onclick="toggleFilters()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="4" y1="21" x2="4" y2="14"/>
                        <line x1="4" y1="10" x2="4" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12" y2="3"/>
                        <line x1="20" y1="21" x2="20" y2="16"/>
                        <line x1="20" y1="12" x2="20" y2="3"/>
                        <line x1="1" y1="14" x2="7" y2="14"/>
                        <line x1="9" y1="8" x2="15" y2="8"/>
                        <line x1="17" y1="16" x2="23" y2="16"/>
                    </svg>
                    <span class="filter-badge" id="filter-badge">0</span>
                </button>
                
                <!-- PULSANTE MULTI per fatturazione batch -->
                <button class="btn-batch-mode" id="btn-batch-mode" onclick="toggleBatchMode()" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                    </svg>
                    Multi
                </button>
                
                <button class="btn-new" onclick="openModal(true)" title="Nuovo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                </button>
            </div>
            
            <div class="filters-panel" id="filters-panel">
                <div class="filters-inner">
                    <div class="filter-toggle-container">
                        <div class="filter-toggle">
                            <button class="filter-toggle-btn active" data-filter="miei" onclick="setFilterType('miei')">I miei</button>
                            <button class="filter-toggle-btn" data-filter="tutti" onclick="setFilterType('tutti')" id="btn-tutti" style="display: none;">Tutti</button>
                        </div>
                        <button class="btn-reset-filters" onclick="resetFilters()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                <path d="M3 3v5h5"/>
                            </svg>
                            Reset
                        </button>
                    </div>
                    
                    <div class="filters-grid">
                        <div class="filter-group full-width" id="filter-operatore-group" style="display: none;">
                            <span class="filter-label">Operatore</span>
                            <select class="filter-input" id="filter-operatore" onchange="applyFilters()">
                                <option value="">Tutti gli operatori</option>
                            </select>
                        </div>
                        
                        <div class="filter-group full-width">
                            <span class="filter-label">Cliente</span>
                            <input type="text" class="filter-input" id="filter-cliente" placeholder="Filtra per cliente..." oninput="applyFilters()">
                        </div>
                        
                        <div class="filter-group">
                            <span class="filter-label">Ore min</span>
                            <input type="number" class="filter-input" id="filter-durata-min" placeholder="0" min="0" step="0.5" onchange="applyFilters()">
                        </div>
                        
                        <div class="filter-group">
                            <span class="filter-label">Ore max</span>
                            <input type="number" class="filter-input" id="filter-durata-max" placeholder="‚àû" min="0" step="0.5" onchange="applyFilters()">
                        </div>
                        
                        <div class="filter-group full-width">
                            <span class="filter-label">Periodo</span>
                            <div class="date-range">
                                <input type="date" id="filter-data-da" onchange="applyFilters()">
                                <span>‚Üí</span>
                                <input type="date" id="filter-data-a" onchange="applyFilters()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="active-filters" id="active-filters"></div>
        </section>
        
        <main class="page-content" id="page-content">
            <div class="stats-summary" id="stats-summary">
                <div class="stat-chip stat-notifiche" id="stat-notifiche-chip" style="display: none;">
                    <span class="stat-chip-value" id="stat-notifiche">0</span>
                    <span class="stat-chip-label" id="stat-notifiche-label">Nuovi</span>
                </div>
                <div class="stat-chip clickable" data-filter="totali" onclick="toggleStatFilter('totali')">
                    <span class="stat-chip-value" id="stat-totali">0</span>
                    <span class="stat-chip-label">Totali</span>
                </div>
                <div class="stat-chip clickable" data-filter="validati" onclick="toggleStatFilter('validati')">
                    <span class="stat-chip-value" id="stat-validati">0</span>
                    <span class="stat-chip-label">Validati</span>
                </div>
                <div class="stat-chip clickable" data-filter="non-validati" onclick="toggleStatFilter('non-validati')">
                    <span class="stat-chip-value" id="stat-non-validati">0</span>
                    <span class="stat-chip-label">Da validare</span>
                </div>
                <div class="stat-chip clickable" data-filter="fatturati" onclick="toggleStatFilter('fatturati')">
                    <span class="stat-chip-value" id="stat-fatturati">0</span>
                    <span class="stat-chip-label">Fatturati</span>
                </div>
            </div>
            
            <div class="bollettini-list" id="bollettini-list"></div>
            
            <div class="empty-state" id="empty-state" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p id="empty-message">Nessun bollettino trovato</p>
            </div>
        </main>
    </div>
    
    <!-- BARRA SELEZIONE BATCH -->
    <div class="batch-selection-bar" id="batch-selection-bar">
        <div class="batch-selection-info">
            <span class="batch-selection-count" id="batch-count">0</span>
            <span>selezionati</span>
        </div>
        <div class="batch-selection-actions">
            <button class="btn-batch-cancel" onclick="toggleBatchMode()">Annulla</button>
            <button class="btn-batch-invoice" id="btn-batch-invoice-action" onclick="openBatchInvoiceModal()" disabled>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13"/>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                </svg>
                Fattura
            </button>
        </div>
    </div>
    
    <!-- MODALE FATTURAZIONE BATCH -->
    <div class="modal-overlay" id="modal-fatturazione-batch">
        <div class="modal-container modal-fattura-batch">
            <div class="modal-header">
                <h2 class="modal-title">üì¶ Fatturazione Multipla</h2>
                <button class="modal-close" onclick="closeBatchInvoiceModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="batch-form-section">
                    <div class="batch-form-section-title">üìã Bollettini selezionati</div>
                    <div class="batch-bollettini-list" id="batch-bollettini-list"></div>
                </div>
                
                <div class="batch-form-section">
                    <div class="batch-form-section-title">üìß Email Cliente * (obbligatoria)</div>
                    <input type="email" class="batch-email-input" id="batch-email-cliente" placeholder="email@cliente.it">
                </div>
                
                <div class="batch-form-section">
                    <div class="batch-form-section-title">üìÑ Carica DDT</div>
                    <div class="batch-ddt-upload" onclick="document.getElementById('batch-ddt-input').click()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <span class="batch-ddt-upload-text">Tocca per caricare PDF</span>
                    </div>
                    <input type="file" id="batch-ddt-input" accept=".pdf" multiple style="display: none;" onchange="handleBatchDDTUpload(event)">
                    <div class="batch-ddt-list" id="batch-ddt-list"></div>
                </div>
                
                <div class="batch-form-section">
                    <div class="batch-form-section-title">üìù Note (opzionale)</div>
                    <textarea class="batch-notes-input" id="batch-invoice-notes" placeholder="Note aggiuntive..."></textarea>
                </div>
            </div>
            <div class="batch-modal-footer">
                <button class="btn-complete-batch" id="btn-complete-batch-invoice" onclick="completeBatchInvoice()" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                    </svg>
                    Completa Fatturazione
                </button>
            </div>
        </div>
    </div>

    <!-- I MODALI ORIGINALI VENGONO INCLUSI QUI -->
    <!-- Questo file pu√≤ essere integrato con il resto dei modali dal file originale -->
    
    


    <div class="modal-overlay" id="modal-bollettino">
        <div class="modal-container">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="modal-title">Nuovo Bollettino</h2>
                    <button class="modal-close" onclick="closeModal()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="bollettino-id">
                    
                    <!-- Sezione Data e Orari -->
                    <div class="form-section">
                        <div class="form-section-title">üìÖ Data e Orari</div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label class="form-label">Data</label>
                                <input type="date" class="form-input" id="bollettino-data">
                            </div>
                        </div>
                        <div class="form-row triple">
                            <div class="form-group">
                                <label class="form-label">Inizio</label>
                                <input type="time" class="form-input" id="bollettino-orario-inizio">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fine</label>
                                <input type="time" class="form-input" id="bollettino-orario-fine">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pausa (min)</label>
                                <input type="number" class="form-input" id="bollettino-pausa" placeholder="60" min="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ore Totali</label>
                            <div class="ore-display" id="bollettino-ore">0.00 h</div>
                        </div>
                    </div>
                    
                    <!-- Sezione Intervento -->
                    <div class="form-section">
                        <div class="form-section-title">üîß Intervento</div>
                        <div class="form-group">
                            <label class="form-label">Cliente *</label>
                            <input type="text" class="form-input" id="bollettino-cliente" placeholder="Nome cliente">
                        </div>
                        <div class="form-group">
                            <label class="form-label">üìß Email Cliente</label>
                            <input type="email" class="form-input" id="bollettino-email" placeholder="email@cliente.it">
                            <p class="form-hint">Per inviare copia del bollettino firmato</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Macchina</label>
                            <input type="text" class="form-input" id="bollettino-macchina" placeholder="Tipo macchina / modello">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Matricola</label>
                            <input type="text" class="form-input" id="bollettino-matricola" placeholder="Numero matricola macchina">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tecnico</label>
                            <input type="text" class="form-input readonly" id="bollettino-tecnico" readonly>
                        </div>
                    </div>
                    
                    <!-- Sezione Lavori -->
                    <div class="form-section">
                        <div class="form-section-title">üìù Descrizione</div>
                        <div class="form-group">
                            <label class="form-label">Lavori Eseguiti</label>
                            <textarea class="form-textarea" id="bollettino-lavori" placeholder="Descrizione dettagliata dei lavori..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Note</label>
                            <textarea class="form-textarea" id="bollettino-note" placeholder="Note aggiuntive, osservazioni..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Sezione Foto Prima/Dopo Intervento -->
                    <div class="form-section">
                        <div class="form-section-title">üì∏ Foto Intervento</div>
                        
                        <!-- Foto PRIMA -->
                        <div class="photos-section">
                            <div class="photos-header">
                                <span class="photos-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    Foto PRIMA
                                </span>
                                <button class="btn-add-photo" onclick="document.getElementById('foto-prima-input').click()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Aggiungi
                                </button>
                            </div>
                            <div class="photos-grid" id="foto-prima-list">
                                <div class="photo-item photo-add-placeholder" onclick="document.getElementById('foto-prima-input').click()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="12" y1="8" x2="12" y2="16"/>
                                        <line x1="8" y1="12" x2="16" y2="12"/>
                                    </svg>
                                    <span>Aggiungi</span>
                                </div>
                            </div>
                            <input type="file" id="foto-prima-input" accept="image/*" multiple style="display:none;" onchange="handleFotoPrimaUpload(event)">
                        </div>
                        
                        <!-- Foto DOPO -->
                        <div class="photos-section" style="margin-top: var(--space-4);">
                            <div class="photos-header">
                                <span class="photos-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    Foto DOPO
                                </span>
                                <button class="btn-add-photo" onclick="document.getElementById('foto-dopo-input').click()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Aggiungi
                                </button>
                            </div>
                            <div class="photos-grid" id="foto-dopo-list">
                                <div class="photo-item photo-add-placeholder" onclick="document.getElementById('foto-dopo-input').click()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="12" y1="8" x2="12" y2="16"/>
                                        <line x1="8" y1="12" x2="16" y2="12"/>
                                    </svg>
                                    <span>Aggiungi</span>
                                </div>
                            </div>
                            <input type="file" id="foto-dopo-input" accept="image/*" multiple style="display:none;" onchange="handleFotoDopoUpload(event)">
                        </div>
                        
                        <p class="form-hint" style="margin-top: var(--space-2);">Documenta l'intervento con foto prima e dopo</p>
                    </div>
                    
                    <!-- Sezione Firma -->
                    <div class="form-section">
                        <div class="form-section-title">‚úçÔ∏è Firma Cliente</div>
                        <!-- Nome Firmatario -->
                        <div class="form-group">
                            <label class="form-label">Nome e Cognome Firmatario</label>
                            <input type="text" class="form-input" id="bollettino-firmatario" placeholder="Nome e cognome di chi firma">
                        </div>
                        
                        <div class="firma-container">
                            <div class="firma-header">
                                <span>Firma qui sotto</span>
                                <button class="btn-clear-firma" onclick="clearFirma()">Cancella</button>
                            </div>
                            <div class="firma-canvas-wrapper" id="firma-wrapper">
                                <canvas class="firma-canvas" id="firma-canvas"></canvas>
                                <div class="firma-placeholder">Firma qui con il dito</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sezione Scontrini Pranzo -->
                    <div class="form-section">
                        <div class="form-section-title">üßæ Scontrini Pranzo</div>
                        <div class="photos-section">
                            <div class="photos-header">
                                <span class="photos-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    Foto scontrini
                                </span>
                                <button class="btn-add-photo" onclick="document.getElementById('scontrini-input').click()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Aggiungi
                                </button>
                            </div>
                            <div class="photos-grid" id="photos-grid">
                                <div class="photo-item photo-add-placeholder" onclick="document.getElementById('scontrini-input').click()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="12" y1="8" x2="12" y2="16"/>
                                        <line x1="8" y1="12" x2="16" y2="12"/>
                                    </svg>
                                    <span>Aggiungi</span>
                                </div>
                            </div>
                            <input type="file" id="scontrini-input" accept="image/*" multiple onchange="handlePhotoUpload(event)">
                            <p class="form-hint" style="margin-top: var(--space-2);">Puoi caricare pi√π foto di scontrini del pranzo</p>
                        </div>
                        
                        <!-- Totale Speso -->
                        <div class="form-group" style="margin-top: var(--space-4);">
                            <label class="form-label">üí∞ Totale Speso (‚Ç¨)</label>
                            <div class="input-with-icon">
                                <input type="number" class="form-input" id="bollettino-totale-speso" placeholder="0.00" step="0.01" min="0">
                                <span class="input-icon-suffix">‚Ç¨</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal btn-cancel" onclick="closeModal()">Annulla</button>
                    <button class="btn-modal btn-save" onclick="saveBollettino()">Salva</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Dettaglio -->
    <div class="modal-overlay" id="modal-dettaglio">
        <div class="modal-container">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Dettaglio Bollettino</h2>
                    <button class="modal-close" onclick="closeModalDettaglio()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body" id="dettaglio-body">
                    <!-- Popolato via JS -->
                </div>
                <div class="modal-footer-admin" id="dettaglio-footer">
                    <!-- Azioni Admin -->
                    <div class="admin-actions" id="admin-actions" style="display: none;">
                        <button class="btn-validate" id="btn-validate" onclick="confirmValidate()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            Valida
                        </button>
                        <button class="btn-invoice" id="btn-invoice" onclick="openInvoiceModal(currentBollettinoId)" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                            Fattura
                        </button>
                        <button class="btn-delete" id="btn-delete" onclick="confirmDelete()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                <line x1="10" y1="11" x2="10" y2="17"/>
                                <line x1="14" y1="11" x2="14" y2="17"/>
                            </svg>
                            Elimina
                        </button>
                    </div>
                    <!-- Azioni principali -->
                    <div class="main-actions">
                        <button class="btn-modal btn-cancel" onclick="closeModalDettaglio()">Chiudi</button>
                        <button class="btn-modal btn-save" id="btn-modifica" onclick="openModalModifica()">Modifica</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dialog Conferma Eliminazione -->
    <div class="confirm-dialog" id="confirm-delete-dialog">
        <div class="confirm-box">
            <div class="confirm-icon danger">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            </div>
            <h3 class="confirm-title">Elimina Bollettino</h3>
            <p class="confirm-message">Sei sicuro di voler eliminare questo bollettino? Questa azione non pu√≤ essere annullata.</p>
            <div class="confirm-actions">
                <button class="confirm-btn confirm-btn-cancel" onclick="closeConfirmDialog('delete')">Annulla</button>
                <button class="confirm-btn confirm-btn-danger" onclick="deleteBollettino()">Elimina</button>
            </div>
        </div>
    </div>
    
    <!-- Dialog Conferma Validazione -->
    <div class="confirm-dialog" id="confirm-validate-dialog">
        <div class="confirm-box">
            <div class="confirm-icon success">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
            </div>
            <h3 class="confirm-title">Valida Bollettino</h3>
            <p class="confirm-message">Confermi la validazione di questo bollettino? Una volta validato non potr√† pi√π essere eliminato.</p>
            <div class="confirm-actions">
                <button class="confirm-btn confirm-btn-cancel" onclick="closeConfirmDialog('validate')">Annulla</button>
                <button class="confirm-btn confirm-btn-primary" onclick="validateBollettino()">Valida</button>
            </div>
        </div>
    </div>
    
    <!-- Dialog Invio Email Cliente -->
    <div class="confirm-dialog" id="confirm-email-cliente-dialog">
        <div class="confirm-box">
            <div class="confirm-icon email">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
            </div>
            <h3 class="confirm-title">Invia Copia al Cliente</h3>
            <p class="confirm-message">Vuoi inviare una copia del bollettino firmato a <strong id="email-destinatario"></strong>?</p>
            <div class="confirm-actions">
                <button class="confirm-btn confirm-btn-cancel" onclick="closeEmailDialog(false)">No, grazie</button>
                <button class="confirm-btn confirm-btn-email" onclick="closeEmailDialog(true)">S√¨, invia</button>
            </div>
        </div>
    </div>
    
    <!-- Dialog Selezione Admin per Notifica Validazione -->
    <div class="confirm-dialog" id="select-admin-dialog">
        <div class="confirm-box" style="max-width: 360px;">
            <div class="confirm-icon email">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
            </div>
            <h3 class="confirm-title">Notifica Validazione</h3>
            <p class="confirm-message" style="margin-bottom: 16px;">Invia notifica email a:</p>
            <div class="admin-select-list" id="admin-select-list">
                <!-- Popolato dinamicamente -->
            </div>
            <div class="confirm-actions">
                <button class="confirm-btn confirm-btn-cancel" onclick="closeAdminSelectDialog(false)">Annulla</button>
                <button class="confirm-btn confirm-btn-email" onclick="closeAdminSelectDialog(true)">Valida e Invia</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Visualizza Foto -->
    <div class="modal-overlay" id="modal-photo" onclick="closePhotoModal()">
        <div class="modal-container" style="display: flex; align-items: center; justify-content: center;">
            <img id="photo-preview" src="" alt="Foto" style="max-width: 95%; max-height: 90vh; border-radius: var(--radius-lg);">
        </div>
    </div>
    
    <!-- Modal Fatturazione -->
    <div class="modal-overlay" id="modal-fatturazione">
        <div class="modal-container modal-fattura">
            <div class="modal-header modal-header-fattura">
                <div class="modal-header-content">
                    <h2 class="modal-title">üì¶ Fatturazione</h2>
                </div>
                <button class="modal-close" onclick="closeInvoiceModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body invoice-modal-body">
                <!-- Info Riepilogo Compatto -->
                <div class="invoice-riepilogo">
                    <div class="invoice-riepilogo-row">
                        <span class="invoice-riepilogo-label">Cliente</span>
                        <span class="invoice-riepilogo-value" id="invoice-cliente">-</span>
                    </div>
                    <div class="invoice-riepilogo-row">
                        <span class="invoice-riepilogo-label">Macchina</span>
                        <span class="invoice-riepilogo-value" id="invoice-macchina">-</span>
                    </div>
                    <div class="invoice-riepilogo-row">
                        <span class="invoice-riepilogo-label">Data</span>
                        <span class="invoice-riepilogo-value" id="invoice-data">-</span>
                    </div>
                </div>
                
                <!-- Upload DDT -->
                <div class="invoice-section">
                    <div class="invoice-section-title">üìÑ Carica DDT</div>
                    <div class="ddt-upload-box" onclick="document.getElementById('ddt-file-input').click()">
                        <svg class="ddt-upload-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <span class="ddt-upload-label">Tocca per caricare PDF</span>
                    </div>
                    <input type="file" id="ddt-file-input" accept=".pdf" multiple style="display: none;" onchange="handleDDTUpload(event)">
                    
                    <!-- Lista DDT caricati -->
                    <div class="ddt-files-list" id="uploaded-ddt-list"></div>
                </div>
                
                <!-- Note (opzionale, collapsato) -->
                <div class="invoice-section">
                    <label class="invoice-note-label">Note (opzionale)</label>
                    <textarea class="invoice-note-input" id="invoice-notes" placeholder="Note aggiuntive..." rows="2"></textarea>
                </div>
            </div>
            <div class="invoice-footer">
                <button class="invoice-submit-btn" id="btn-complete-invoice" onclick="completeInvoice()" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                    </svg>
                    Completa e Invia
                </button>
            </div>
        </div>
    </div>
    

    <script src="bollettini.js"></script>
</body>
</html>
