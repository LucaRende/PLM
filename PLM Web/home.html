<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Home - PLM Web</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/PLM/favicon.ico">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Stili -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="Load/loader.css">
    
    <!-- CONTROLLO AUTENTICAZIONE - Blocca subito se non loggato -->
    <script>
        (function() {
            const isLogged = sessionStorage.getItem('plm_logged_in') || localStorage.getItem('plm_logged_in');
            if (isLogged !== 'true') {
                window.location.replace('login.html');
            }
        })();
    </script>
    
    <!-- Nascondi contenuto finché loader non è attivo -->
    <style id="preload-style">
        body { background: #ffffff; }
        .page { visibility: hidden; }
    </style>
    
    <style>
        /* =============================================
           TEMA CHIARO - OVERRIDE
           ============================================= */
        :root {
            --surface-0: #ffffff !important;
            --surface-1: #f8f9fa !important;
            --surface-2: #f1f3f5 !important;
            --surface-3: #e9ecef !important;
            --surface-4: #dee2e6 !important;
            --text-primary: #212529 !important;
            --text-secondary: #495057 !important;
            --text-muted: #868e96 !important;
            --border-default: #dee2e6 !important;
            --border-subtle: #e9ecef !important;
            --border-strong: #adb5bd !important;
        }
        
        html, body {
            background: #ffffff !important;
        }
        
        .page {
            background: #ffffff !important;
        }
        
        /* Header resta nero */
        .home-header {
            background: rgba(3, 3, 5, 0.92) !important;
        }
        
        .home-header .home-user-surname {
            color: #ffffff !important;
        }
        
        .home-header .home-user-name {
            color: rgba(255, 255, 255, 0.7) !important;
        }
        
        /* Content sfondo bianco */
        .home-content {
            background: #ffffff !important;
        }
        
        /* Stat box per tema chiaro */
        .stat-box {
            background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%) !important;
            border-color: #dee2e6 !important;
        }
        
        .stat-box::before {
            background: linear-gradient(90deg, transparent, #dc2626, transparent) !important;
        }
        
        /* Menu items */
        .menu-item {
            background: #f8f9fa !important;
            border-color: #dee2e6 !important;
        }
        
        .menu-item:active {
            background: #e9ecef !important;
        }
        
        .menu-item-title {
            color: #212529 !important;
        }
        
        .menu-item-desc {
            color: #868e96 !important;
        }
        /* =============================================
           HOME - SUPER DESIGN IPHONE
           ============================================= */
        
        /* Header Fisso Premium */
        .home-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: var(--space-3) var(--space-4);
            background: rgba(3, 3, 5, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Logo centrato senza effetti */
        .home-logo {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .home-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* User info a sinistra */
        .home-user-info {
            display: flex;
            flex-direction: column;
        }
        
        .home-user-surname {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .home-user-name {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            line-height: 1.3;
        }
        
        /* Logout button */
        .btn-logout {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 10px;
            color: var(--error);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.05);
        }
        
        .btn-logout svg {
            width: 18px;
            height: 18px;
        }
        
        /* Content con padding top per header fisso */
        .home-content {
            padding: 80px var(--space-4) var(--space-4);
            min-height: 100vh;
            background: var(--surface-0);
        }
        
        /* Welcome Section */
        .home-welcome {
            text-align: center;
            margin-bottom: var(--space-6);
            padding: var(--space-4) 0;
        }
        
        .welcome-greeting {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: var(--space-1);
        }
        
        .welcome-name {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }
        
        .welcome-date {
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }
        
        .welcome-date::before,
        .welcome-date::after {
            content: '';
            width: 20px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-strong));
        }
        
        .welcome-date::after {
            background: linear-gradient(90deg, var(--border-strong), transparent);
        }
        
        /* Stat Grid Premium */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
            padding: 0;
            margin-bottom: var(--space-5);
        }
        
        /* Stat Box Premium - Altezza fissa uguale */
        .stat-box {
            background: linear-gradient(145deg, var(--surface-2) 0%, var(--surface-1) 100%);
            border: 1px solid var(--border-default);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }
        
        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 1;
        }
        
        .stat-box .stat-slider {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .stat-box .stat-slider-track {
            flex: 1;
        }
        
        .stat-box-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .stat-box-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(220, 38, 38, 0.15);
        }
        
        .stat-box-icon svg {
            width: 16px;
            height: 16px;
            color: var(--primary);
        }
        
        .stat-box-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .stat-slide {
            padding: var(--space-4) var(--space-3);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: var(--space-1);
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .stat-dots {
            padding: var(--space-2);
            gap: var(--space-1);
            display: flex;
            justify-content: center;
            margin-top: auto;
        }
        
        .stat-dot {
            width: 6px;
            height: 6px;
        }
        
        .stat-dot.active {
            width: 16px;
        }
        
        /* Menu Section Title */
        .menu-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: var(--space-2) var(--space-1);
            margin-bottom: var(--space-2);
        }
        
        /* Menu Buttons Premium */
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            padding: 0;
        }
        
        .menu-btn {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .menu-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform var(--transition-fast);
        }
        
        .menu-btn:hover {
            background: var(--surface-3);
            border-color: var(--primary);
            transform: translateX(4px);
            color: var(--text-primary);
        }
        
        .menu-btn:hover::before {
            transform: scaleY(1);
        }
        
        .menu-btn:active {
            transform: translateX(2px) scale(0.98);
        }
        
        /* Menu Button Locked */
        .menu-btn.locked {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }
        
        .menu-btn.locked::before {
            display: none;
        }
        
        .menu-btn.locked svg:first-child {
            color: var(--text-muted);
        }
        
        .menu-btn.locked .arrow {
            display: none;
        }
        
        .menu-btn .lock-icon {
            display: none;
            width: 18px;
            height: 18px;
            color: var(--text-muted);
            margin-left: auto;
        }
        
        .menu-btn.locked .lock-icon {
            display: block;
        }
        
        .menu-btn svg {
            width: 22px;
            height: 22px;
            color: var(--primary);
            flex-shrink: 0;
        }
        
        .menu-btn span {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
        }
        
        .menu-btn .arrow {
            width: 18px;
            height: 18px;
            color: var(--text-muted);
            transition: all var(--transition-fast);
        }
        
        .menu-btn:hover .arrow {
            transform: translateX(4px);
            color: var(--primary);
        }
        
        /* Menu Button Super Admin - Stile speciale */
        .menu-btn-superadmin {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(220, 38, 38, 0.15));
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        
        .menu-btn-superadmin::before {
            background: linear-gradient(180deg, #a855f7, #dc2626);
        }
        
        .menu-btn-superadmin svg:first-child {
            color: #a855f7;
        }
        
        .menu-btn-superadmin:hover {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.25), rgba(220, 38, 38, 0.25));
            border-color: #a855f7;
        }
        
        .menu-btn-superadmin:hover svg:first-child {
            color: #c084fc;
        }
        
        .menu-btn-superadmin span {
            background: linear-gradient(90deg, #a855f7, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }
        
        /* Footer */
        .footer {
            padding: var(--space-6) var(--space-4);
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
            border-top: 1px solid var(--border-subtle);
            margin-top: var(--space-6);
        }
        
        /* Safe area per iPhone */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .footer {
                padding-bottom: calc(var(--space-6) + env(safe-area-inset-bottom));
            }
            
            .home-header {
                padding-top: calc(var(--space-3) + env(safe-area-inset-top));
            }
            
            .home-content {
                padding-top: calc(80px + env(safe-area-inset-top));
            }
        }
    </style>
    
    <script src="Load/loader.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            Loader.show('pagina', 'Caricamento...');
            // Mostra contenuto
            document.querySelector('.page').style.visibility = 'visible';
        });
    </script>
</head>
<body>
    <div class="page">
        <!-- Header Fisso Premium -->
        <header class="home-header">
            <div class="home-user-info">
                <div class="home-user-surname" id="userSurname">Cognome</div>
                <div class="home-user-name" id="userFirstName">Nome</div>
            </div>
            
            <div class="home-logo">
                <img src="/PLM/logo-tondo.png" alt="PLM">
            </div>
            
            <button class="btn-logout" onclick="logout()" title="Esci">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </button>
        </header>
        
        <!-- Content -->
        <main class="home-content">
            <!-- Welcome Section -->
            <div class="home-welcome">
                <div class="welcome-greeting">Bentornato</div>
                <div class="welcome-name" id="welcomeName">Utente</div>
                <div class="welcome-date" id="currentDate"></div>
            </div>
            
            <!-- Stat Boxes Grid -->
            <div class="stat-grid">
                <!-- Box Presenze -->
                <div class="stat-box" id="boxPresenze">
                    <div class="stat-box-header">
                        <div class="stat-box-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="8.5" cy="7" r="4"/>
                                <polyline points="17 11 19 13 23 9"/>
                            </svg>
                        </div>
                        <span class="stat-box-title">Presenze</span>
                    </div>
                    <div class="stat-slider" data-slides="2" data-current="0">
                        <div class="stat-slider-track">
                            <!-- Slide 1: Numero -->
                            <div class="stat-slide">
                                <div class="stat-number" id="presenzeCount">0</div>
                                <div class="stat-label">presenze registrate</div>
                            </div>
                            <!-- Slide 2: Lista -->
                            <div class="stat-slide">
                                <div class="stat-list" id="presenzeList">
                                    <div class="stat-empty">Nessuna presenza</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-dots">
                        <div class="stat-dot active" data-slide="0"></div>
                        <div class="stat-dot" data-slide="1"></div>
                    </div>
                </div>
                
                <!-- Box Permessi -->
                <div class="stat-box" id="boxPermessi">
                    <div class="stat-box-header">
                        <div class="stat-box-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                        </div>
                        <span class="stat-box-title">Permessi</span>
                    </div>
                    <div class="stat-slider" data-slides="3" data-current="0">
                        <div class="stat-slider-track">
                            <!-- Slide 1: Numero -->
                            <div class="stat-slide">
                                <div class="stat-number" id="permessiCount">0</div>
                                <div class="stat-label">permessi approvati</div>
                            </div>
                            <!-- Slide 2: Ultimi approvati -->
                            <div class="stat-slide">
                                <div class="stat-list" id="permessiApprovati">
                                    <div class="stat-empty">Nessun permesso</div>
                                </div>
                            </div>
                            <!-- Slide 3: Da visualizzare -->
                            <div class="stat-slide">
                                <div class="stat-list" id="permessiPending">
                                    <div class="stat-empty">Nessuna notifica</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-dots">
                        <div class="stat-dot active" data-slide="0"></div>
                        <div class="stat-dot" data-slide="1"></div>
                        <div class="stat-dot" data-slide="2"></div>
                    </div>
                </div>
            </div>
            
            <!-- Menu Pulsanti -->
            <div class="menu-section-title">Aree di lavoro</div>
            <div class="menu-buttons" id="menu-buttons">
                <a href="ufficio-tecnico.html" class="menu-btn" data-page="ufficio-tecnico">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                    </svg>
                    <span>Ufficio Tecnico</span>
                    <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </a>
                <a href="commerciale.html" class="menu-btn" data-page="commerciale">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    <span>Commerciale</span>
                    <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </a>
                <a href="bollettini.html" class="menu-btn" data-page="bollettini">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <span>Bollettini</span>
                    <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </a>
                <a href="trasporti.html" class="menu-btn" data-page="trasporti">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="1" y="3" width="15" height="13"/>
                        <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                        <circle cx="5.5" cy="18.5" r="2.5"/>
                        <circle cx="18.5" cy="18.5" r="2.5"/>
                    </svg>
                    <span>Trasporti</span>
                    <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </a>
                <a href="amministrazione.html" class="menu-btn" data-page="amministrazione">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="16" rx="2"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                        <line x1="9" y1="10" x2="9" y2="20"/>
                        <line x1="15" y1="10" x2="15" y2="20"/>
                    </svg>
                    <span>Amministrazione</span>
                    <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </a>
                <!-- SUPER ADMIN - Visibile solo per superAdmin -->
                <a href="https://lucarende.github.io/PLM/PLM%20Web/editor.html" class="menu-btn menu-btn-superadmin" id="btn-superadmin" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    <span>Super Admin</span>
                    <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </a>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="footer">
            © 2026 PLM Web — Pro System s.r.l. — Powered by: Luca Rende
        </footer>
    </div>

    <script>
        // Variabili globali
        let supabaseClient = null;
        let currentUser = null;
        let isSuperAdmin = false;
        
        // Init Supabase
        async function initSupabase() {
            try {
                const response = await fetch('/PLM/autenticazione.json');
                const config = await response.json();
                supabaseClient = supabase.createClient(config.supabase.url, config.supabase.anonKey);
                return true;
            } catch (error) {
                console.error('Errore Supabase:', error);
                return false;
            }
        }
        
        // Carica dati utente
        function loadUserData() {
            currentUser = JSON.parse(localStorage.getItem('plm_user') || sessionStorage.getItem('plm_user') || '{}');
            
            // Header: Cognome sopra (grande), Nome sotto (piccolo grigio)
            if (currentUser.cognome) {
                document.getElementById('userSurname').textContent = currentUser.cognome;
            }
            if (currentUser.nome) {
                document.getElementById('userFirstName').textContent = currentUser.nome;
                document.getElementById('welcomeName').textContent = currentUser.nome;
            }
            
            // Check se è Super Admin
            const ruolo = (currentUser.ruolo || '').toLowerCase();
            isSuperAdmin = ruolo === 'superadmin';
            
            // Mostra pulsante Super Admin solo se è superAdmin
            if (isSuperAdmin) {
                const btnSuperAdmin = document.getElementById('btn-superadmin');
                if (btnSuperAdmin) {
                    btnSuperAdmin.style.display = 'flex';
                }
            }
            
            // Data corrente formattata bella
            const oggi = new Date();
            const giorni = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
            const mesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            const dataFormattata = giorni[oggi.getDay()] + ' ' + oggi.getDate() + ' ' + mesi[oggi.getMonth()];
            document.getElementById('currentDate').textContent = dataFormattata;
        }
        
        // Carica presenze
        async function loadPresenze() {
            if (!supabaseClient || !currentUser.id) return;
            
            try {
                const { data, error } = await supabaseClient.rpc('get_presenze', {
                    p_user_id: currentUser.id,
                    p_limit: 5
                });
                
                if (error) throw error;
                
                document.getElementById('presenzeCount').textContent = data.totale || 0;
                
                if (data.lista && data.lista.length > 0) {
                    document.getElementById('presenzeList').innerHTML = data.lista.map(p => `
                        <div class="stat-list-item">
                            <span class="stat-list-date">${formatDate(p.data)}</span>
                            <div class="stat-list-times">
                                ${p.entrata1 ? `<span class="stat-list-time in">↓${p.entrata1}</span>` : ''}
                                ${p.uscita1 ? `<span class="stat-list-time out">↑${p.uscita1}</span>` : ''}
                                ${p.entrata2 ? `<span class="stat-list-time in">↓${p.entrata2}</span>` : ''}
                                ${p.uscita2 ? `<span class="stat-list-time out">↑${p.uscita2}</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Errore caricamento presenze:', error);
            }
        }
        
        // Carica permessi
        async function loadPermessi() {
            if (!supabaseClient || !currentUser.id) return;
            
            try {
                const { data, error } = await supabaseClient.rpc('get_permessi', {
                    p_user_id: currentUser.id,
                    p_limit: 5
                });
                
                if (error) throw error;
                
                document.getElementById('permessiCount').textContent = data.totale || 0;
                
                if (data.approvati && data.approvati.length > 0) {
                    document.getElementById('permessiApprovati').innerHTML = data.approvati.map(p => `
                        <div class="stat-list-item">
                            <span class="stat-list-date">${formatDate(p.data_permesso)}</span>
                            <div class="stat-list-times">
                                <span>${p.ora_inizio || ''} - ${p.ora_fine || ''}</span>
                            </div>
                            <span class="stat-list-status approved">✓</span>
                        </div>
                    `).join('');
                }
                
                if (data.da_visualizzare && data.da_visualizzare.length > 0) {
                    document.getElementById('permessiPending').innerHTML = data.da_visualizzare.map(p => `
                        <div class="stat-list-item">
                            <span class="stat-list-date">${formatDate(p.data_permesso)}</span>
                            <div class="stat-list-times">
                                <span>${p.ora_inizio || ''} - ${p.ora_fine || ''}</span>
                            </div>
                            <span class="stat-list-status ${p.stato === 'approvato' ? 'approved' : p.stato === 'rifiutato' ? 'rejected' : 'pending'}">
                                ${p.stato === 'approvato' ? '✓' : p.stato === 'rifiutato' ? '✗' : '...'}
                            </span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Errore caricamento permessi:', error);
            }
        }
        
        // Formatta data
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
        }
        
        // Logout
        function logout() {
            sessionStorage.removeItem('plm_logged_in');
            sessionStorage.removeItem('plm_user');
            localStorage.removeItem('plm_logged_in');
            localStorage.removeItem('plm_user');
            window.location.href = 'login.html';
        }
        
        // =============================================
        // BLOCCO MENU IN BASE AI PERMESSI
        // =============================================
        function applyMenuPermissions() {
            // Ottieni permessi utente
            const userPermessi = currentUser.permessi_pagine || ['home'];
            const permessiArray = Array.isArray(userPermessi) ? userPermessi : JSON.parse(userPermessi || '["home"]');
            
            console.log('Permessi utente:', permessiArray);
            
            // Applica blocco a ogni bottone menu
            document.querySelectorAll('.menu-btn[data-page]').forEach(btn => {
                const page = btn.dataset.page;
                
                if (!permessiArray.includes(page)) {
                    // L'utente NON ha il permesso per questa pagina
                    btn.classList.add('locked');
                    btn.removeAttribute('href');
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                }
            });
        }
        
        // =============================================
        // SWIPE LOGIC
        // =============================================
        function initSwipeBoxes() {
            document.querySelectorAll('.stat-slider').forEach(slider => {
                const track = slider.querySelector('.stat-slider-track');
                const box = slider.closest('.stat-box');
                const dots = box.querySelectorAll('.stat-dot');
                const slidesCount = parseInt(slider.dataset.slides) || 2;
                let current = 0;
                let startX = 0;
                let isDragging = false;
                
                function goToSlide(index) {
                    current = Math.max(0, Math.min(index, slidesCount - 1));
                    track.style.transform = `translateX(-${current * 100}%)`;
                    slider.dataset.current = current;
                    
                    dots.forEach((dot, i) => {
                        dot.classList.toggle('active', i === current);
                    });
                }
                
                // Touch events
                slider.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    isDragging = true;
                }, { passive: true });
                
                slider.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    const endX = e.changedTouches[0].clientX;
                    const diff = startX - endX;
                    
                    if (Math.abs(diff) > 50) {
                        if (diff > 0 && current < slidesCount - 1) {
                            goToSlide(current + 1);
                        } else if (diff < 0 && current > 0) {
                            goToSlide(current - 1);
                        }
                    }
                }, { passive: true });
                
                // Click sui dots
                dots.forEach((dot, i) => {
                    dot.addEventListener('click', () => goToSlide(i));
                });
            });
        }
        
        // Init
        window.addEventListener('load', async function() {
            loadUserData();
            await initSupabase();
            initSwipeBoxes();
            applyMenuPermissions();
            
            // Carica dati (commenta se non hai ancora le tabelle)
            // await loadPresenze();
            // await loadPermessi();
            
            Loader.hide();
        });
    </script>
</body>
</html>
